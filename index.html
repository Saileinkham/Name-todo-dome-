<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≤‡∏¢‡πÇ‡∏î‡∏°</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            display: none !important; /* Hidden - using dashboard instead */
        }

        .sidebar-nav.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Kanit', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .sidebar-logo-icon {
            font-size: 1.8rem;
        }

        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .sidebar-item:hover {
            background: var(--bg-hover);
            transform: translateX(5px);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
            border-color: var(--primary);
        }

        .sidebar-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .sidebar-item-icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        .sidebar-item-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-item-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .sidebar-item-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .sidebar-item-badge {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        .sidebar-item-badge.danger {
            background: var(--danger);
        }

        .sidebar-item-badge.success {
            background: var(--success);
        }

        .sidebar-item-badge.warning {
            background: var(--warning);
        }

        .sidebar-divider {
            height: 1px;
            background: var(--border);
            margin: 15px 0;
        }

        .sidebar-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 10px 0;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            color: white;
            font-size: 1.5rem;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar-toggle.show {
            display: flex;
        }

        /* Main Content with Sidebar */
        .main-wrapper {
            margin-left: 0; /* Full width - no sidebar */
            transition: margin-left 0.3s ease;
        }

        .main-wrapper.full-width {
            margin-left: 0;
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            display: none;
            backdrop-filter: blur(4px);
        }

        .sidebar-overlay.show {
            display: block;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: headerPulse 15s ease-in-out infinite;
        }

        @keyframes headerPulse {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(10%, 10%) scale(1.1); }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-family: 'Kanit', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .header-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Kanit', sans-serif;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* Dashboard Summary */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .summary-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .summary-card-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-card-icon {
            font-size: 1.5rem;
        }

        .summary-card-total {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .summary-card-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-main);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .summary-item:hover {
            background: var(--bg-hover);
            transform: translateX(4px);
        }

        .summary-item-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .summary-item-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .summary-item-bar {
            height: 6px;
            background: var(--bg-main);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .summary-item-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Branch Styles */
        .branch-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .branch-section {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .branch-section-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .branch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .branch-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .branch-option:hover {
            border-color: var(--success);
            background: var(--bg-hover);
        }

        .branch-option.selected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .branch-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .branch-option label {
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .branch-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .branch-time-display {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Custom Category Styles */
        .category-section {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .category-section-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .category-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .category-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .category-icon-input {
            width: 60px;
            padding: 10px;
            text-align: center;
            font-size: 1.2rem;
        }

        .category-name-input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 10px;
        }

        .custom-category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .custom-category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 2px solid var(--border);
        }

        .custom-category-item:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
        }

        .custom-category-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-category-icon {
            font-size: 1.3rem;
        }

        .custom-category-name {
            font-weight: 600;
        }

        .custom-category-actions {
            display: flex;
            gap: 5px;
        }

        /* Enhanced Calendar Day */
        .calendar-day-content {
            display: flex;
            flex-direction: column;
            gap: 3px;
            height: 100%;
        }

        .calendar-task-item {
            font-size: 0.65rem;
            padding: 2px 4px;
            background: var(--bg-card);
            border-radius: 4px;
            border-left: 3px solid;
            display: flex;
            align-items: center;
            gap: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-task-item:hover {
            background: var(--bg-hover);
            transform: translateX(2px);
        }

        .calendar-task-item.priority-high {
            border-left-color: var(--danger);
        }

        .calendar-task-item.priority-medium {
            border-left-color: var(--warning);
        }

        .calendar-task-item.priority-low {
            border-left-color: var(--success);
        }

        .calendar-task-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .calendar-task-time {
            color: var(--text-secondary);
            font-size: 0.6rem;
        }

        .calendar-task-branch {
            color: var(--success);
            font-weight: 700;
        }

        .calendar-more-tasks {
            font-size: 0.65rem;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            padding: 2px 4px;
            text-align: center;
        }

        .calendar-more-tasks:hover {
            background: var(--bg-hover);
            border-radius: 4px;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            backdrop-filter: blur(5px);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease-out;
        }

        .settings-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .settings-modal-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
        }

        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-main);
            border-radius: 16px;
            border: 2px solid var(--border);
        }

        .settings-section-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-section-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* Branch Visit Entry */
        .branch-visit-section {
            margin-top: 12px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            border-radius: 12px;
            border: 2px solid var(--success);
        }

        .branch-visit-title {
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .branch-visit-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .calendar-branch-visit {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 3px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-branch-visit:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .calendar-branch-visit:hover::after {
            content: '‚úèÔ∏è';
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .branch-visit-time {
            font-size: 0.65rem;
            opacity: 0.9;
        }

        /* Edit Branch Visit Modal */
        .edit-branch-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1003;
            backdrop-filter: blur(5px);
        }

        .edit-branch-modal.active {
            display: flex;
        }

        .edit-branch-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease-out;
        }

        .edit-branch-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .edit-branch-modal-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--success);
        }

        .edit-branch-form-group {
            margin-bottom: 20px;
        }

        .edit-branch-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .edit-branch-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background: var(--bg-main);
            color: var(--text-primary);
        }

        .edit-branch-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Leave Types Styles */
        .leave-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 16px;
            border: 2px solid var(--border);
        }

        .leave-summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .leave-summary-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .leave-summary-icon {
            font-size: 2rem;
        }

        .leave-summary-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .leave-summary-count {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Kanit', sans-serif;
        }

        .leave-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 700;
            color: white;
            margin-top: 2px;
        }

        .leave-holiday {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .leave-vacation {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .leave-sick {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .leave-personal {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        /* Emoji Picker Styles */
        .emoji-picker-container {
            position: relative;
            display: inline-block;
        }

        .emoji-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .emoji-display {
            width: 50px;
            height: 50px;
            border: 2px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-card);
        }

        .emoji-display:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .emoji-display.empty::after {
            content: 'üòä';
            opacity: 0.3;
        }

        .emoji-picker-popup {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            max-width: 320px;
            margin-top: 8px;
        }

        .emoji-picker-popup.active {
            display: block;
        }

        .emoji-picker-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
        }

        .emoji-item {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .emoji-item:hover {
            background: var(--bg-hover);
            transform: scale(1.2);
        }

        @media (max-width: 768px) {
            .branch-visit-form {
                grid-template-columns: 1fr;
            }

            .leave-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 30px;
            padding: 0 40px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-text {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Kanit', sans-serif;
        }

        .progress-bar-bg {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff9f, #00f0ff);
            border-radius: 15px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        .progress-bar-fill.low {
            background: linear-gradient(90deg, #ef4444, #f97316);
        }

        .progress-bar-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-bar-fill.high {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .progress-bar-fill.complete {
            background: linear-gradient(90deg, #00ff9f, #00f0ff);
        }

        .progress-details {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 12px;
            font-size: 0.9rem;
            opacity: 0.95;
        }

        .progress-detail-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Controls */
        .controls {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .controls-top {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Sarabun', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--primary);
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--bg-main);
            color: var(--text-secondary);
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 8px;
            background: var(--bg-main);
            padding: 4px;
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .view-btn {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Calendar View */
        .calendar-container {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: none;
        }

        .calendar-container.active {
            display: block;
        }

        /* Calendar Stats */
        .calendar-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-main);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .calendar-stat-card {
            text-align: center;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .calendar-stat-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .calendar-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Kanit', sans-serif;
            margin-bottom: 5px;
        }

        .calendar-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Day Off Styles */
        .calendar-day.day-off {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(245, 158, 11, 0.15));
            border-color: var(--secondary);
        }

        .day-off-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: linear-gradient(135deg, var(--secondary), var(--warning));
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .day-off-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .day-off-toggle:hover {
            background: var(--bg-light);
        }

        .day-off-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .leave-type-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-card);
        }

        .leave-type-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .leave-type-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .leave-type-option input[type="radio"]:checked ~ span {
            font-weight: 700;
            color: var(--primary);
        }

        /* Legend */
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--border);
        }

        .legend-color.today {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(236, 72, 153, 0.3));
            border-color: var(--primary);
        }

        .legend-color.has-todos {
            background: var(--bg-main);
            border-color: var(--success);
        }

        .legend-color.day-off {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.3), rgba(245, 158, 11, 0.3));
            border-color: var(--secondary);
        }

        .legend-color.overdue {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
        }

        /* Recurring Task Styles */
        .recurring-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .recurring-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.6);
            animation: recurringPulse 2s ease-in-out infinite;
        }

        @keyframes recurringPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .recurring-options {
            margin-top: 12px;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 10px;
            border: 2px solid var(--border);
            display: none;
        }

        .recurring-options.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .recurring-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .recurring-toggle:hover {
            background: var(--bg-light);
        }

        .recurring-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .recurring-toggle label {
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .recurring-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .recurring-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .recurring-field label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .recurring-field select,
        .recurring-field input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .weekday-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .weekday-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .weekday-btn:hover {
            border-color: var(--primary);
        }

        .weekday-btn.selected {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border-color: #8b5cf6;
        }

        .recurring-preview {
            margin-top: 12px;
            padding: 12px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            border-left: 4px solid #8b5cf6;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .recurring-preview-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #8b5cf6;
        }

        /* Bulk Add Tasks */
        .bulk-add-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }

        .bulk-add-toggle:hover {
            background: var(--bg-light);
        }

        .bulk-add-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .bulk-add-toggle label {
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bulk-add-container {
            margin-top: 15px;
            padding: 20px;
            background: var(--bg-main);
            border-radius: 12px;
            border: 2px solid var(--border);
            display: none;
        }

        .bulk-add-container.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .bulk-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .bulk-add-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .bulk-add-help {
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: rgba(99, 102, 241, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .bulk-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            background: var(--bg-card);
            color: var(--text-primary);
            resize: vertical;
            transition: all 0.3s ease;
        }

        .bulk-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .bulk-textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .bulk-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .bulk-setting {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .bulk-setting label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .bulk-preview {
            margin-top: 15px;
            padding: 15px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .bulk-preview-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-preview-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .bulk-preview-item {
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-preview-item .icon {
            font-size: 1rem;
        }

        .bulk-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            min-width: 28px;
        }

        /* Edit Todo Modal */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(5px);
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease-out;
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .edit-modal-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .edit-form-group {
            margin-bottom: 20px;
        }

        .edit-form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .edit-form-input,
        .edit-form-select,
        .edit-form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .edit-form-input:focus,
        .edit-form-select:focus,
        .edit-form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .edit-form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .edit-form-time-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .edit-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        @media (max-width: 768px) {
            .edit-form-row {
                grid-template-columns: 1fr;
            }
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .calendar-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.75rem;
            font-weight: 600;
        }

        .calendar-nav {
            display: flex;
            gap: 12px;
        }

        .nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .calendar-day::-webkit-scrollbar {
            width: 4px;
        }

        .calendar-day::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .calendar-day:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
        }

        .calendar-day.has-todos {
            border-color: var(--success);
        }

        .day-number {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .today .day-number {
            color: var(--primary);
            font-weight: 700;
        }

        .day-todos {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            overflow: hidden;
        }

        .day-todo-dot {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--primary);
        }

        .day-todo-dot.completed {
            background: var(--success);
        }

        .day-todo-dot.high {
            background: var(--danger);
        }

        .day-todo-dot.medium {
            background: var(--warning);
        }

        .day-todo-count {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 600;
        }

        /* Calendar Modal */
        .calendar-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .calendar-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        /* Add Todo Form */
        .add-todo-form {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 200px 120px 100px 100px auto;
            gap: 12px;
            margin-bottom: 12px;
        }

        input[type="time"] {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        input[type="time"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .time-range-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="date"],
        select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        select:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .category-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .category-tag {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .category-tag.work {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .category-tag.personal {
            background: rgba(236, 72, 153, 0.1);
            color: var(--secondary);
        }

        .category-tag.shopping {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .category-tag.health {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .category-tag.study {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .category-tag.active {
            border-color: currentColor;
            font-weight: 600;
        }

        /* Todo List */
        .todo-sections {
            display: grid;
            gap: 30px;
        }

        .section {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .section-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-count {
            background: var(--bg-hover);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .todo-item {
            background: var(--bg-main);
            padding: 16px;
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 16px;
            align-items: start;
            animation: todoSlide 0.3s ease-out;
        }

        @keyframes todoSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .todo-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateX(5px);
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
        }

        .checkbox-wrapper {
            position: relative;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox:hover {
            border-color: var(--primary);
        }

        .checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .todo-content {
            flex: 1;
        }

        .todo-text {
            font-size: 1.1rem;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .todo-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .priority-low {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .due-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .due-date.overdue {
            color: var(--danger);
            font-weight: 600;
        }

        .todo-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .icon-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .icon-btn.delete:hover {
            background: var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            font-size: 1.5rem;
            z-index: 100;
        }

        .theme-toggle:hover {
            transform: rotate(180deg) scale(1.1);
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--border);
            z-index: 999;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification-panel.show {
            display: block;
        }

        .notification-header {
            padding: 20px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 14px 14px 0 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .notification-list {
            padding: 15px;
        }

        .notification-item {
            padding: 12px;
            background: var(--bg-main);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .notification-item.urgent {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }

        .notification-item.today {
            border-left-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }

        .notification-text {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }

        /* Week Plan */
        .week-plan {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .week-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .week-plan-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-days {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .week-day-card {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .week-day-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .week-day-card.today {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(236, 72, 153, 0.05));
        }

        .week-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .week-day-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .week-day-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .week-day-todos {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .week-todo-item {
            display: flex;
            align-items: start;
            gap: 8px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .week-todo-item:hover {
            border-color: var(--primary);
        }

        .week-todo-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
            transition: all 0.3s ease;
        }

        .week-todo-checkbox:hover {
            border-color: var(--primary);
        }

        .week-todo-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
            position: relative;
        }

        .week-todo-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .week-todo-content {
            flex: 1;
        }

        .week-todo-text {
            margin-bottom: 3px;
        }

        .week-todo-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .week-todo-meta {
            display: flex;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .week-branch-visit {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .week-leave-item {
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: white;
        }

        .week-leave-item.leave-holiday {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .week-leave-item.leave-vacation {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .week-leave-item.leave-sick {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .week-leave-item.leave-personal {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-bell:hover {
            animation: bellRing 0.5s ease-in-out;
        }

        @keyframes bellRing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        /* Export/Import Menu */
        .export-menu {
            position: relative;
            display: inline-block;
        }

        .export-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .export-dropdown.show {
            display: block;
            animation: dropdownSlide 0.3s ease-out;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
        }

        .export-option:hover {
            background: var(--bg-hover);
        }

        .export-option:active {
            background: var(--primary);
            color: white;
        }

        .file-input-hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar-nav {
                transform: translateX(-280px);
            }

            .sidebar-nav.open {
                transform: translateX(0);
            }

            .sidebar-toggle.show {
                display: flex;
            }

            .main-wrapper {
                margin-left: 0 !important;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .time-range-label {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .controls-top {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .header-stats {
                gap: 15px;
                grid-template-columns: repeat(3, 1fr);
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .calendar-grid {
                gap: 4px;
            }

            .calendar-day {
                padding: 4px;
            }

            .day-number {
                font-size: 0.7rem;
            }

            .day-todo-count {
                font-size: 0.6rem;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .week-days {
                grid-template-columns: 1fr;
            }

            .notification-panel {
                width: 90%;
                right: 5%;
            }

            .sidebar-nav {
                width: 260px;
            }

            .sidebar-toggle {
                left: 10px;
                top: 10px;
                width: 45px;
                height: 45px;
            }

            .todo-item {
                font-size: 0.9rem;
            }

            .todo-meta {
                flex-wrap: wrap;
                gap: 6px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .category-tags {
                gap: 6px;
            }

            .category-tag {
                font-size: 0.8rem;
                padding: 6px 10px;
            }

            input, select, textarea {
                font-size: 0.95rem !important;
            }
        }

        @media (min-width: 1440px) {
            .container {
                max-width: 1400px;
            }

            .header h1 {
                font-size: 3rem;
            }

            body {
                font-size: 17px;
            }
        }

        @media (min-width: 1920px) {
            .container {
                max-width: 1600px;
            }

            body {
                font-size: 18px;
            }

            .header h1 {
                font-size: 3.5rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar-nav" id="sidebarNav">
        <div class="sidebar-header">
            <div class="sidebar-logo" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="sidebar-logo-icon">üìã</span>
                    <span id="appNameDisplay">‡πÇ‡∏î‡∏°</span>
                </div>
                <button onclick="editAppName()" style="background: rgba(255,255,255,0.1); border: none; color: var(--text-primary); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏û">‚úèÔ∏è</button>
            </div>
        </div>

        <div class="sidebar-menu">
            <!-- Dashboard -->
            <div class="sidebar-item active" onclick="navigateTo('dashboard')" data-section="dashboard">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üè†</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                        <span class="sidebar-item-desc">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </div>
                </div>
                <span class="sidebar-item-badge" id="sidebarTotalTodos">0</span>
            </div>

            <!-- Today -->
            <div class="sidebar-item" onclick="navigateTo('today')" data-section="today">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üìÖ</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                        <span class="sidebar-item-desc">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                    </div>
                </div>
                <span class="sidebar-item-badge warning" id="sidebarTodayTodos">0</span>
            </div>

            <!-- Upcoming -->
            <div class="sidebar-item" onclick="navigateTo('upcoming')" data-section="upcoming">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üìÜ</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">5 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>
                        <span class="sidebar-item-desc">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>
                    </div>
                </div>
                <span class="sidebar-item-badge" id="sidebarUpcomingTodos">0</span>
            </div>

            <!-- Overdue -->
            <div class="sidebar-item" onclick="navigateTo('overdue')" data-section="overdue">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">‚ö†Ô∏è</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
                        <span class="sidebar-item-desc">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡∏ó‡∏≥</span>
                    </div>
                </div>
                <span class="sidebar-item-badge danger" id="sidebarOverdueTodos">0</span>
            </div>

            <div class="sidebar-divider"></div>

            <!-- Calendar -->
            <div class="sidebar-item" onclick="navigateTo('calendar')" data-section="calendar">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üìä</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</span>
                        <span class="sidebar-item-desc">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                    </div>
                </div>
            </div>

            <!-- Recurring -->
            <div class="sidebar-item" onclick="navigateTo('recurring')" data-section="recurring">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üîÑ</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</span>
                        <span class="sidebar-item-desc">‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</span>
                    </div>
                </div>
                <span class="sidebar-item-badge" id="sidebarRecurringTodos">0</span>
            </div>

            <div class="sidebar-section-title">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>

            <!-- Categories -->
            <div class="sidebar-item" onclick="navigateTo('work')" data-section="work">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üíº</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏á‡∏≤‡∏ô</span>
                    </div>
                </div>
                <span class="sidebar-item-badge" id="sidebarWorkTodos">0</span>
            </div>

            <div class="sidebar-item" onclick="navigateTo('personal')" data-section="personal">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üë§</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</span>
                    </div>
                </div>
                <span class="sidebar-item-badge" id="sidebarPersonalTodos">0</span>
            </div>

            <div class="sidebar-item" onclick="navigateTo('shopping')" data-section="shopping">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üõí</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</span>
                    </div>
                </div>
                <span class="sidebar-item-badge" id="sidebarShoppingTodos">0</span>
            </div>

            <div class="sidebar-item" onclick="navigateTo('health')" data-section="health">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üí™</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</span>
                    </div>
                </div>
                <span class="sidebar-item-badge" id="sidebarHealthTodos">0</span>
            </div>

            <div class="sidebar-item" onclick="navigateTo('study')" data-section="study">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üìö</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    </div>
                </div>
                <span class="sidebar-item-badge" id="sidebarStudyTodos">0</span>
            </div>

            <!-- Custom Categories (Dynamic) -->
            <div id="customCategoriesSidebar"></div>

            <div class="sidebar-divider"></div>

            <!-- Leave Report -->
            <div class="sidebar-item" onclick="navigateTo('leave-report')" data-section="leave-report">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">üèñÔ∏è</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤</span>
                        <span class="sidebar-item-desc">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</span>
                    </div>
                </div>
                <span class="sidebar-badge" id="leaveYearlyCount">0</span>
            </div>

            <div class="sidebar-divider"></div>

            <!-- Completed -->
            <div class="sidebar-item" onclick="navigateTo('completed')" data-section="completed">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">‚úÖ</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
                        <span class="sidebar-item-desc">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à</span>
                    </div>
                </div>
                <span class="sidebar-item-badge success" id="sidebarCompletedTodos">0</span>
            </div>

            <!-- Spacer to push settings to bottom -->
            <div style="flex: 1;"></div>

            <div class="sidebar-divider"></div>

            <!-- Settings at bottom -->
            <div class="sidebar-item" onclick="openSettings()" data-section="settings">
                <div class="sidebar-item-content">
                    <span class="sidebar-item-icon">‚öôÔ∏è</span>
                    <div class="sidebar-item-text">
                        <span class="sidebar-item-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                        <span class="sidebar-item-desc">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Toggle Button -->
    <div class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        ‚ò∞
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Wrapper -->
    <div class="main-wrapper" id="mainWrapper">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <!-- Logo and Title Section -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <!-- Logo Upload -->
                    <div style="position: relative; cursor: pointer;" onclick="document.getElementById('logoUpload').click()">
                        <img id="appLogo" src="" alt="" style="max-width: 100px; max-height: 100px; border-radius: 50%; display: none; border: 4px solid var(--primary); box-shadow: var(--shadow-lg); transition: all 0.3s ease; object-fit: cover;">
                        <div id="logoPlaceholder" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; border: 4px solid var(--primary); box-shadow: var(--shadow-lg); cursor: pointer; transition: all 0.3s ease;">
                            üìã
                        </div>
                        <div style="position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); font-size: 1rem;">
                            üì∑
                        </div>
                        <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                    </div>
                    
                    <!-- Editable App Name -->
                    <div style="text-align: center;">
                        <h1 id="appNameDisplay" style="cursor: pointer; display: inline-block; padding: 8px 16px; border-radius: 8px; transition: all 0.3s ease;" onclick="editAppName()" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                            üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≤‡∏¢‡πÇ‡∏î‡∏°
                        </h1>
                        <input type="text" id="appNameInput" style="display: none; font-size: 2.5rem; font-weight: 700; font-family: 'Kanit', sans-serif; text-align: center; border: 2px solid var(--primary); border-radius: 12px; padding: 10px; width: 90%; max-width: 500px; background: var(--bg-card);" onblur="saveAppName()" onkeypress="if(event.key==='Enter') saveAppName()">
                        <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</p>
                    </div>
                </div>
                
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalTodos">0</div>
                        <div class="stat-label">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="completedTodos">0</div>
                        <div class="stat-label">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingTodos">0</div>
                        <div class="stat-label">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-label">
                        <span class="progress-text">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                        <span class="progress-percentage" id="progressPercentage">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-details">
                        <div class="progress-detail-item">
                            <span>‚úÖ</span>
                            <span id="completedCount">0</span>
                            <span>/</span>
                            <span id="totalCount">0</span>
                            <span>‡∏á‡∏≤‡∏ô</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Summary -->
        <div class="dashboard-summary" id="dashboardSummary">
            <!-- Month Summary -->
            <div class="summary-card">
                <div class="summary-card-header">
                    <div class="summary-card-title">
                        <span class="summary-card-icon">üìÖ</span>
                        <span>‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                    </div>
                    <div class="summary-card-total" id="monthTotalTasks">0</div>
                </div>
                <div class="summary-card-body">
                    <div class="summary-item">
                        <div class="summary-item-label">
                            <span>‚úÖ</span>
                            <span>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
                        </div>
                        <div class="summary-item-value" style="color: var(--success);" id="monthCompletedTasks">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">
                            <span>‚è≥</span>
                            <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>
                        </div>
                        <div class="summary-item-value" style="color: var(--warning);" id="monthPendingTasks">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">
                            <span>‚ö†Ô∏è</span>
                            <span>‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
                        </div>
                        <div class="summary-item-value" style="color: var(--danger);" id="monthOverdueTasks">0</div>
                    </div>
                </div>
            </div>

            <!-- Category Summary -->
            <div class="summary-card">
                <div class="summary-card-header">
                    <div class="summary-card-title">
                        <span class="summary-card-icon">üìä</span>
                        <span>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>
                    </div>
                </div>
                <div class="summary-card-body" id="categorySummary">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Branch Summary -->
            <div class="summary-card">
                <div class="summary-card-header">
                    <div class="summary-card-title">
                        <span class="summary-card-icon">üè¢</span>
                        <span>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</span>
                    </div>
                    <select id="branchFontSize" onchange="updateBranchFontSize()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-primary); font-size: 0.8rem; cursor: pointer;">
                        <option value="0.8">‡πÄ‡∏•‡πá‡∏Å</option>
                        <option value="0.9">‡∏Å‡∏•‡∏≤‡∏á</option>
                        <option value="1.0" selected>‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        <option value="1.1">‡πÉ‡∏´‡∏ç‡πà</option>
                        <option value="1.2">‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å</option>
                    </select>
                </div>
                <div class="summary-card-body" id="branchSummary" style="font-size: 1rem;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Leave Summary -->
            <div class="summary-card">
                <div class="summary-card-header">
                    <div class="summary-card-title">
                        <span class="summary-card-icon">üèñÔ∏è</span>
                        <span>‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î</span>
                    </div>
                </div>
                <div class="summary-card-body">
                    <div class="summary-item">
                        <div class="summary-item-label">
                            <span>üèñÔ∏è</span>
                            <span>Day Off</span>
                        </div>
                        <div class="summary-item-value" id="summaryDayOff">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">
                            <span>üéâ</span>
                            <span>‡∏•‡∏≤‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå</span>
                        </div>
                        <div class="summary-item-value" id="summaryHoliday">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">
                            <span>üèùÔ∏è</span>
                            <span>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</span>
                        </div>
                        <div class="summary-item-value" id="summaryVacation">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">
                            <span>ü§í</span>
                            <span>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</span>
                        </div>
                        <div class="summary-item-value" id="summarySick">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">
                            <span>üìù</span>
                            <span>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</span>
                        </div>
                        <div class="summary-item-value" id="summaryPersonal">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-top">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô...">
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('list')">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    <button class="view-btn" onclick="switchView('calendar')">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
                </div>
                <div class="notification-bell" onclick="toggleNotifications()" style="position: relative;">
                    <button class="btn btn-secondary" style="padding: 12px 16px;">
                        üîî <span id="notificationCount"></span>
                    </button>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </div>
                <div class="export-menu">
                    <button class="btn btn-secondary" onclick="toggleExportMenu()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ‚ñº</button>
                    <div class="export-dropdown" id="exportDropdown">
                        <button class="export-option" onclick="exportToExcel()">
                            üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel (.xlsx)
                        </button>
                        <button class="export-option" onclick="exportToCSV()">
                            üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                        </button>
                        <button class="export-option" onclick="exportToJSON()">
                            üíæ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON
                        </button>
                        <button class="export-option" onclick="document.getElementById('importFile').click()">
                            üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel/CSV
                        </button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="clearCompleted()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à</button>
            </div>
            <input type="file" id="importFile" class="file-input-hidden" accept=".xlsx,.xls,.csv" onchange="importFile(event)">
            <div class="filters">
                <button class="filter-btn active" data-filter="all" onclick="filterTodos('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" data-filter="active" onclick="filterTodos('active')">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                <button class="filter-btn" data-filter="completed" onclick="filterTodos('completed')">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                <button class="filter-btn" data-filter="high" onclick="filterTodos('high')">üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å</button>
                <button class="filter-btn" data-filter="medium" onclick="filterTodos('medium')">üü° ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</button>
                <button class="filter-btn" data-filter="low" onclick="filterTodos('low')">üü¢ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ô‡πâ‡∏≠‡∏¢</button>
            </div>
        </div>

        <!-- Add Todo Form -->
        <div class="add-todo-form">
            <!-- Branch Visit Entry (Now at top - Primary function) -->
            <div class="branch-visit-section" style="margin-top: 0; margin-bottom: 20px;">
                <div class="branch-visit-title">
                    üè¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤
                    <span style="font-size: 0.75rem; font-weight: 400; color: var(--text-secondary);">(‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</span>
                </div>
                <div class="branch-visit-form">
                    <div>
                        <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; display: block;">
                            ‡∏™‡∏≤‡∏Ç‡∏≤ 
                            <button onclick="openQuickManageBranches()" style="background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: 8px;" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
                        </label>
                        <select id="branchVisitBranch" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 10px;">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                            <option value="B011">B011</option>
                            <option value="B016">B016</option>
                            <option value="B018">B018</option>
                            <option value="B024">B024</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; display: block;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="branchVisitDate" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 10px;">
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; display: block;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label>
                        <input type="time" id="branchVisitTime" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 10px;">
                    </div>
                    <button class="btn btn-primary" onclick="addBranchVisit()" style="white-space: nowrap;">
                        ‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </div>

            <!-- Bulk Add Button (Only way to add tasks now) -->
            <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="toggleBulkAdd()" style="font-size: 1.1rem; padding: 14px 40px;">
                    üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (Bulk Add)
                </button>
            </div>

            <!-- Bulk Add Tasks -->
            <div class="bulk-add-container" id="bulkAddContainer">
                <div class="bulk-add-header">
                    <div class="bulk-add-title">‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</div>
                </div>

                <div class="bulk-add-help">
                    üí° <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà (Enter)<br>
                    üìå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <code>‡∏á‡∏≤‡∏ô | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç | ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà | ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° | ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î | ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</code><br>
                    üé® <strong>‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô:</strong> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà emoji ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô üî• üìä üí™ üè†<br>
                    üìã <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</strong> <code>‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° | high | work | 2026-01-27 | 09:00 | 11:00 | üìä</code>
                </div>

                <textarea 
                    id="bulkTaskInput" 
                    class="bulk-textarea" 
                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1 ‡∏á‡∏≤‡∏ô)

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° | high | work | 2026-01-28 | 09:00 | 11:00 | üìä
‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô | high | work | 2026-01-28 | 14:00 | | üìÑ
‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á | medium | shopping | | | | üõí
‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ | high | health | 2026-01-27 | 06:00 | 07:00 | üí™
‡∏ó‡∏≥‡∏á‡∏≤‡∏ô | medium | work | 2026-01-27 | 09:00 | 18:00 | üî•

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):
‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô | low | personal | 2026-01-30 | 10:00 | 12:00 | üè†"
                    oninput="updateBulkPreview()"
                ></textarea>

                <div class="bulk-settings">
                    <div class="bulk-setting">
                        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <select id="bulkDefaultPriority">
                            <option value="low">üü¢ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ô‡πâ‡∏≠‡∏¢</option>
                            <option value="medium" selected>üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                            <option value="high">üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å</option>
                        </select>
                    </div>

                    <div class="bulk-setting">
                        <label>
                            ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                            <button onclick="openQuickManageCategories()" style="background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: 8px;" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
                        </label>
                        <select id="bulkDefaultCategory">
                            <option value="personal" selected>üë§ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                            <option value="work">üíº ‡∏á‡∏≤‡∏ô</option>
                            <option value="shopping">üõí ‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</option>
                            <option value="health">üí™ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</option>
                            <option value="study">üìö ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                        </select>
                    </div>

                    <div class="bulk-setting">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="date" id="bulkDefaultDate">
                    </div>

                    <div class="bulk-setting">
                        <label>üé® ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <div class="emoji-picker-container">
                            <div class="emoji-input-wrapper">
                                <div class="emoji-display" id="bulkEmojiDisplay" onclick="toggleEmojiPicker('bulk')"></div>
                                <button class="btn btn-secondary" onclick="clearBulkEmoji()" style="padding: 8px 12px;">üóëÔ∏è</button>
                            </div>
                            <div class="emoji-picker-popup" id="bulkEmojiPicker">
                                <div class="emoji-picker-header">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</div>
                                <div class="emoji-grid" id="bulkEmojiGrid">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bulk-preview" id="bulkPreview" style="display: none;">
                    <div class="bulk-preview-title">
                        üìã ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <span class="bulk-count" id="bulkCount">0</span> ‡∏á‡∏≤‡∏ô
                    </div>
                    <div class="bulk-preview-list" id="bulkPreviewList">
                        <!-- Preview items will be added here -->
                    </div>
                </div>

                <div class="bulk-actions">
                    <button class="btn btn-primary" onclick="addBulkTasks()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="bulkAddCount">0</span> ‡∏á‡∏≤‡∏ô)
                    </button>
                    <button class="btn btn-secondary" onclick="clearBulkInput()">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    </button>
                    <button class="btn btn-secondary" onclick="toggleBulkAdd()">
                        ‚úï ‡∏õ‡∏¥‡∏î
                    </button>
                </div>
            </div>

            <!-- Recurring Options -->
            <div class="recurring-toggle" onclick="toggleRecurringOptions()">
                <input type="checkbox" id="recurringCheckbox" onclick="event.stopPropagation()">
                <label for="recurringCheckbox">üîÑ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ (Recurring Task)</label>
            </div>

            <div class="recurring-options" id="recurringOptions">
                <div class="recurring-config">
                    <div class="recurring-field">
                        <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</label>
                        <select id="recurringType" onchange="updateRecurringConfig()">
                            <option value="daily">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</option>
                            <option value="weekly">‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                            <option value="monthly">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                            <option value="weekdays">‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                            <option value="weekends">‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                            <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                        </select>
                    </div>

                    <div class="recurring-field" id="intervalField">
                        <label>‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <input type="number" id="recurringInterval" value="1" min="1" max="365" onchange="updateRecurringPreview()">
                    </div>

                    <div class="recurring-field" style="grid-column: 1 / -1;" id="weekdayField" style="display: none;">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</label>
                        <div class="weekday-selector">
                            <button type="button" class="weekday-btn" data-day="0" onclick="toggleWeekday(0)">‡∏≠‡∏≤</button>
                            <button type="button" class="weekday-btn" data-day="1" onclick="toggleWeekday(1)">‡∏à</button>
                            <button type="button" class="weekday-btn" data-day="2" onclick="toggleWeekday(2)">‡∏≠</button>
                            <button type="button" class="weekday-btn" data-day="3" onclick="toggleWeekday(3)">‡∏û</button>
                            <button type="button" class="weekday-btn" data-day="4" onclick="toggleWeekday(4)">‡∏û‡∏§</button>
                            <button type="button" class="weekday-btn" data-day="5" onclick="toggleWeekday(5)">‡∏®</button>
                            <button type="button" class="weekday-btn" data-day="6" onclick="toggleWeekday(6)">‡∏™</button>
                        </div>
                    </div>

                    <div class="recurring-field">
                        <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å</label>
                        <input type="date" id="recurringStartDate">
                    </div>

                    <div class="recurring-field">
                        <label>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                        <input type="date" id="recurringEndDate">
                    </div>
                </div>

                <div class="recurring-preview" id="recurringPreview">
                    <div class="recurring-preview-title">üìã ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</div>
                    <div id="recurringPreviewText">‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</div>
                </div>
            </div>
        </div>

        <!-- Week Plan -->
        <div class="week-plan" id="weekPlan">
            <div class="week-plan-header">
                <h2 class="week-plan-title">üìÖ 5 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="showDebugInfo()">üîç Debug</button>
                    <button class="btn btn-secondary" onclick="refreshWeekPlan()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                </div>
            </div>
            <div class="week-days" id="weekDays">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Debug Panel -->
        <div id="debugPanel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); padding: 30px; border-radius: 20px; box-shadow: var(--shadow-lg); z-index: 9999; max-width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-family: 'Kanit', sans-serif; font-size: 1.5rem;">üîç Debug: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <button class="close-btn" onclick="closeDebugPanel()">‚úï</button>
            </div>
            <div id="debugContent"></div>
        </div>
        <div id="debugBackdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9998;" onclick="closeDebugPanel()"></div>

        <!-- Notification Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <div class="notification-title">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                <button class="notification-close" onclick="toggleNotifications()">‚úï</button>
            </div>
            <div class="notification-list" id="notificationList">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Todo Sections -->
        <div class="todo-sections" id="todoSections">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Calendar View -->
        <div class="calendar-container" id="calendarView">
            <!-- Calendar Stats -->
            <div class="calendar-stats">
                <div class="calendar-stat-card">
                    <div class="calendar-stat-icon">üìÖ</div>
                    <div class="calendar-stat-value" id="calMonthTodos">0</div>
                    <div class="calendar-stat-label">‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                </div>
                <div class="calendar-stat-card">
                    <div class="calendar-stat-icon">‚úÖ</div>
                    <div class="calendar-stat-value" id="calMonthCompleted">0</div>
                    <div class="calendar-stat-label">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
                <div class="calendar-stat-card">
                    <div class="calendar-stat-icon">‚è≥</div>
                    <div class="calendar-stat-value" id="calMonthPending">0</div>
                    <div class="calendar-stat-label">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="calendar-stat-card">
                    <div class="calendar-stat-icon">üèñÔ∏è</div>
                    <div class="calendar-stat-value" id="calMonthDayOff">0</div>
                    <div class="calendar-stat-label">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</div>
                </div>
            </div>

            <div class="calendar-header">
                <h2 class="calendar-title" id="calendarMonth">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2026</h2>
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="previousMonth()">‚óÄ</button>
                    <button class="nav-btn" onclick="todayMonth()">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                    <button class="nav-btn" onclick="nextMonth()">‚ñ∂</button>
                </div>
            </div>

            <!-- Legend -->
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-color today"></div>
                    <span>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color has-todos"></div>
                    <span>‡∏°‡∏µ‡∏á‡∏≤‡∏ô</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color day-off"></div>
                    <span>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color overdue"></div>
                    <span>‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Calendar Modal -->
        <div class="calendar-modal" id="calendarModal" onclick="closeModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalDate">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...</h3>
                    <button class="close-btn" onclick="closeModal()">‚úï</button>
                </div>
                
                <!-- Leave Type Selection -->
                <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-main); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">üèñÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤/‡∏´‡∏¢‡∏∏‡∏î</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                        <label class="leave-type-option">
                            <input type="radio" name="leaveType" value="" checked onchange="handleLeaveTypeChange()">
                            <span>‚úÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
                        </label>
                        <label class="leave-type-option">
                            <input type="radio" name="leaveType" value="dayoff" onchange="handleLeaveTypeChange()">
                            <span>üèñÔ∏è Day Off</span>
                        </label>
                        <label class="leave-type-option">
                            <input type="radio" name="leaveType" value="holiday" onchange="handleLeaveTypeChange()">
                            <span>üéâ ‡∏•‡∏≤‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå</span>
                        </label>
                        <label class="leave-type-option">
                            <input type="radio" name="leaveType" value="vacation" onchange="handleLeaveTypeChange()">
                            <span>üèùÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</span>
                        </label>
                        <label class="leave-type-option">
                            <input type="radio" name="leaveType" value="sick" onchange="handleLeaveTypeChange()">
                            <span>ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</span>
                        </label>
                        <label class="leave-type-option">
                            <input type="radio" name="leaveType" value="personal" onchange="handleLeaveTypeChange()">
                            <span>üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</span>
                        </label>
                    </div>
                </div>
                
                <div class="todo-list" id="modalTodos">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">üåô</span>
    </div>

    <!-- Edit Todo Modal -->
    <div class="edit-modal" id="editModal" onclick="closeEditModal(event)">
        <div class="edit-modal-content" onclick="event.stopPropagation()">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô</h3>
                <button class="close-btn" onclick="closeEditModal()">‚úï</button>
            </div>

            <div class="edit-form-group">
                <label class="edit-form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
                <textarea id="editTodoText" class="edit-form-textarea" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô..."></textarea>
            </div>

            <div class="edit-form-row">
                <div class="edit-form-group">
                    <label class="edit-form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                    <select id="editTodoPriority" class="edit-form-select">
                        <option value="low">üü¢ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ô‡πâ‡∏≠‡∏¢</option>
                        <option value="medium">üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                        <option value="high">üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å</option>
                    </select>
                </div>

                <div class="edit-form-group">
                    <label class="edit-form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <select id="editTodoCategory" class="edit-form-select">
                        <option value="personal">üë§ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                        <option value="work">üíº ‡∏á‡∏≤‡∏ô</option>
                        <option value="shopping">üõí ‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</option>
                        <option value="health">üí™ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</option>
                        <option value="study">üìö ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    </select>
                </div>
            </div>

            <div class="edit-form-group">
                <label class="edit-form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" id="editTodoDate" class="edit-form-input">
            </div>

            <div class="edit-form-group">
                <label class="edit-form-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                <div class="edit-form-time-group">
                    <div>
                        <label class="edit-form-label" style="font-size: 0.8rem; margin-bottom: 4px;">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                        <input type="time" id="editTodoTimeStart" class="edit-form-input">
                    </div>
                    <div>
                        <label class="edit-form-label" style="font-size: 0.8rem; margin-bottom: 4px;">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="time" id="editTodoTimeEnd" class="edit-form-input">
                    </div>
                </div>
            </div>

            <div class="edit-form-group">
                <label class="edit-form-label">üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤)</label>
                <div class="branch-grid" id="editBranchGrid">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div class="edit-modal-actions">
                <button class="btn btn-primary" onclick="saveEditedTodo()" style="flex: 1;">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button class="btn btn-secondary" onclick="closeEditModal()">
                    ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal" onclick="closeSettings(event)">
        <div class="settings-modal-content" onclick="event.stopPropagation()">
            <div class="settings-modal-header">
                <h2 class="settings-modal-title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
                <button class="close-btn" onclick="closeSettings()">‚úï</button>
            </div>

            <!-- Branch Management Section -->
            <div class="settings-section">
                <div class="settings-section-title">üè¢ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤</div>
                <div class="settings-section-desc">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                
                <div class="branch-input-group">
                    <input type="text" id="settingsBranchInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô B030)" style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem;">
                    <button class="btn btn-primary" onclick="addCustomBranchFromSettings()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</button>
                </div>

                <div class="custom-category-list" id="settingsBranchList" style="margin-top: 15px;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Category Management Section -->
            <div class="settings-section">
                <div class="settings-section-title">üìÇ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
                <div class="settings-section-desc">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                
                <div class="category-input-group">
                    <div class="category-input-row">
                        <input type="text" id="settingsCategoryIcon" class="category-icon-input" placeholder="üìù" maxlength="2" style="font-size: 1.2rem;">
                        <input type="text" id="settingsCategoryName" class="category-name-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)" style="flex: 1; padding: 12px; font-size: 1rem;">
                        <button class="btn btn-primary" onclick="addCustomCategoryFromSettings()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
                    </div>
                </div>

                <div class="custom-category-list" id="settingsCategoryList" style="margin-top: 15px;">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <div style="text-align: center; padding-top: 20px; border-top: 2px solid var(--border);">
                <button class="btn btn-primary" onclick="closeSettings()" style="min-width: 200px;">
                    ‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Branch Visit Modal -->
    <div class="edit-branch-modal" id="editBranchModal" onclick="closeEditBranchModal(event)">
        <div class="edit-branch-modal-content" onclick="event.stopPropagation()">
            <div class="edit-branch-modal-header">
                <h3 class="edit-branch-modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤</h3>
                <button class="close-btn" onclick="closeEditBranchModal()">‚úï</button>
            </div>

            <div class="edit-branch-form-group">
                <label class="edit-branch-label">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <select id="editBranchVisitBranch" class="edit-branch-input">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                    <option value="B011">B011</option>
                    <option value="B016">B016</option>
                    <option value="B018">B018</option>
                    <option value="B024">B024</option>
                </select>
            </div>

            <div class="edit-branch-form-group">
                <label class="edit-branch-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" id="editBranchVisitDate" class="edit-branch-input">
            </div>

            <div class="edit-branch-form-group">
                <label class="edit-branch-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label>
                <input type="time" id="editBranchVisitTime" class="edit-branch-input">
            </div>

            <div class="edit-branch-actions">
                <button class="btn btn-primary" onclick="saveEditedBranchVisit()" style="flex: 1;">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button class="btn" onclick="deleteEditedBranchVisit()" style="background: var(--danger); color: white;">
                    üóëÔ∏è ‡∏•‡∏ö
                </button>
                <button class="btn btn-secondary" onclick="closeEditBranchModal()">
                    ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    </div><!-- Close container -->
    </div><!-- Close main-wrapper -->

    <script>
        // State
        let todos = JSON.parse(localStorage.getItem('todos')) || [];
        let currentFilter = 'all';
        let currentCategory = null;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentView = 'list';
        let currentCalendarDate = new Date();
        let dayOffs = JSON.parse(localStorage.getItem('dayOffs')) || [];
        let leaveDays = JSON.parse(localStorage.getItem('leaveDays')) || [];
        let currentSelectedDate = null;
        let selectedWeekdays = [];
        let currentSection = 'dashboard';
        let selectedBranches = [];
        let customBranches = JSON.parse(localStorage.getItem('customBranches')) || ['OFFICE', 'B012', 'B046'];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        let branchVisits = JSON.parse(localStorage.getItem('branchVisits')) || [];
        let appName = localStorage.getItem('appName') || 'üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≤‡∏¢‡πÇ‡∏î‡∏°';
        let appLogo = localStorage.getItem('appLogo') || '';
        
        // Branch name mappings (editable)
        let branchNames = JSON.parse(localStorage.getItem('branchNames')) || {
            'B011': 'B011',
            'B016': 'B016',
            'B018': 'B018',
            'B024': 'B024'
        };

        // Leave types
        const leaveTypes = {
            holiday: { name: '‡∏•‡∏≤‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå', icon: 'üéâ', color: '#f59e0b' },
            vacation: { name: '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô', icon: 'üèñÔ∏è', color: '#3b82f6' },
            sick: { name: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', icon: 'ü§í', color: '#ef4444' },
            personal: { name: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à', icon: 'üìù', color: '#8b5cf6' }
        };

        // Initialize
        function init() {
            applyTheme();
            loadAppSettings();
            loadCustomBranches();
            loadCustomCategories();
            updateBranchVisitSelector();
            initializeEmojiPickers();
            generateRecurringTasks();
            updateSidebarCounts();
            renderDashboardSummary();
            renderTodos();
            updateStats();
            setDefaultDate();
            renderCalendar();
            updateNotifications();
            renderWeekPlan();
            checkSidebarVisibility();
            
            setInterval(() => {
                updateNotifications();
            }, 60000);

            setInterval(() => {
                generateRecurringTasks();
            }, 3600000);

            window.addEventListener('resize', checkSidebarVisibility);
        }

        // Emoji Picker Functions
        let selectedBulkEmoji = '';
        const commonEmojis = [
            'üî•', '‚≠ê', '‚ú®', 'üí™', 'üéØ', 'üìä', 'üìà', 'üìâ', 'üíº', 'üè¢',
            'üè†', 'üèÉ', 'üöó', '‚úàÔ∏è', 'üé®', 'üé¨', 'üéÆ', 'üì±', 'üíª', '‚å®Ô∏è',
            'üñ®Ô∏è', 'üì∑', 'üìπ', 'üìû', 'üìß', 'üìù', 'üìÑ', 'üìã', 'üìå', 'üìç',
            'üí∞', 'üí≥', 'üíé', 'üéÅ', 'üéÇ', 'üçï', 'üçî', 'üçü', '‚òï', 'üç∫',
            'üèãÔ∏è', '‚öΩ', 'üèÄ', 'üéæ', 'üèä', 'üßò', 'üéµ', 'üé∏', 'üé§', 'üéß',
            'üìö', 'üìñ', '‚úèÔ∏è', 'üñäÔ∏è', 'üìê', 'üî¨', 'üî≠', 'ü©∫', 'üíä', 'üè•',
            'üõí', 'üõçÔ∏è', 'üé™', 'üé≠', 'üé´', 'üéüÔ∏è', 'üèÜ', 'ü•á', 'ü•à', 'ü•â',
            '‚ù§Ô∏è', 'üíö', 'üíô', 'üíõ', 'üß°', 'üíú', 'üñ§', 'ü§ç', 'üëç', 'üëè'
        ];

        function initializeEmojiPickers() {
            // Populate bulk emoji picker
            const bulkGrid = document.getElementById('bulkEmojiGrid');
            if (bulkGrid) {
                bulkGrid.innerHTML = commonEmojis.map(emoji => 
                    `<div class="emoji-item" onclick="selectEmoji('bulk', '${emoji}')">${emoji}</div>`
                ).join('');
            }
        }

        function toggleEmojiPicker(type) {
            const picker = document.getElementById(`${type}EmojiPicker`);
            if (picker) {
                picker.classList.toggle('active');
            }
        }

        function selectEmoji(type, emoji) {
            const display = document.getElementById(`${type}EmojiDisplay`);
            if (display) {
                display.textContent = emoji;
                display.classList.remove('empty');
            }
            
            if (type === 'bulk') {
                selectedBulkEmoji = emoji;
            }
            
            toggleEmojiPicker(type);
        }

        function clearBulkEmoji() {
            selectedBulkEmoji = '';
            const display = document.getElementById('bulkEmojiDisplay');
            if (display) {
                display.textContent = '';
                display.classList.add('empty');
            }
        }

        // Close emoji picker when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.emoji-picker-container')) {
                document.querySelectorAll('.emoji-picker-popup.active').forEach(popup => {
                    popup.classList.remove('active');
                });
            }
        });

        // App Settings Functions
        function loadAppSettings() {
            // Load app name
            document.getElementById('appNameDisplay').textContent = appName;
            document.title = appName.replace('üìã ', '') + ' - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û';
            
            // Load logo
            if (appLogo) {
                document.getElementById('appLogo').src = appLogo;
                document.getElementById('appLogo').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                appLogo = e.target.result;
                localStorage.setItem('appLogo', appLogo);
                
                document.getElementById('appLogo').src = appLogo;
                document.getElementById('appLogo').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
                
                showToast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Logo ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            };
            reader.readAsDataURL(file);
        }

        function editAppName() {
            const display = document.getElementById('appNameDisplay');
            const input = document.getElementById('appNameInput');
            
            input.value = display.textContent;
            display.style.display = 'none';
            input.style.display = 'block';
            input.focus();
            input.select();
        }

        function saveAppName() {
            const display = document.getElementById('appNameDisplay');
            const input = document.getElementById('appNameInput');
            
            const newName = input.value.trim();
            if (newName) {
                appName = newName;
                localStorage.setItem('appName', appName);
                display.textContent = appName;
                document.title = appName.replace(/[üìãüìùüìäüìÖüóÇÔ∏è]/g, '').trim() + ' - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û';
                showToast('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            }
            
            input.style.display = 'none';
            display.style.display = 'inline-block';
        }

        // Initialize
        function init() {
            // CRITICAL FIX: Reload all data from localStorage to fix refresh instability
            try {
                todos = JSON.parse(localStorage.getItem('todos')) || [];
                dayOffs = JSON.parse(localStorage.getItem('dayOffs')) || [];
                leaveDays = JSON.parse(localStorage.getItem('leaveDays')) || [];
                customBranches = JSON.parse(localStorage.getItem('customBranches')) || [];
                customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
                branchVisits = JSON.parse(localStorage.getItem('branchVisits')) || [];
                branchNames = JSON.parse(localStorage.getItem('branchNames')) || {
                    'B011': 'B011',
                    'B016': 'B016',
                    'B018': 'B018',
                    'B024': 'B024'
                };
            } catch (error) {
                console.error('Error reloading data from localStorage:', error);
            }

            applyTheme();
            loadAppSettings();
            loadAppName(); // Load app name
            loadCustomBranches();
            loadCustomCategories();
            updateBranchVisitSelector();
            updateSidebarCategories(); // Update sidebar categories
            generateRecurringTasks();
            updateSidebarCounts();
            renderDashboardSummary();
            renderTodos();
            updateStats();
            setDefaultDate();
            renderCalendar();
            updateNotifications();
            renderWeekPlan();
            checkSidebarVisibility();
            initializeEmojiPickers();
            
            setInterval(() => {
                updateNotifications();
            }, 60000);

            setInterval(() => {
                generateRecurringTasks();
            }, 3600000);

            window.addEventListener('resize', checkSidebarVisibility);
        }

        // App Name Functions
        function loadAppName() {
            const appName = localStorage.getItem('appName') || '‡πÇ‡∏î‡∏°';
            document.getElementById('appNameDisplay').textContent = appName;
            
            // Load branch font size
            const branchFontSize = localStorage.getItem('branchFontSize') || '1.0';
            const branchSelect = document.getElementById('branchFontSize');
            const branchSummary = document.getElementById('branchSummary');
            if (branchSelect && branchSummary) {
                branchSelect.value = branchFontSize;
                branchSummary.style.fontSize = branchFontSize + 'rem';
            }
        }

        function editAppName() {
            const currentName = localStorage.getItem('appName') || '‡πÇ‡∏î‡∏°';
            const newName = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏û:', currentName);
            
            if (newName !== null && newName.trim()) {
                localStorage.setItem('appName', newName.trim());
                document.getElementById('appNameDisplay').textContent = newName.trim();
                showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            }
        }

        function updateBranchFontSize() {
            const size = document.getElementById('branchFontSize').value;
            document.getElementById('branchSummary').style.fontSize = size + 'rem';
            localStorage.setItem('branchFontSize', size);
        }

        // Dashboard Summary Functions
        function renderDashboardSummary() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            
            const monthTodos = todos.filter(t => t.dueDate >= firstDay && t.dueDate <= lastDay);
            const completed = monthTodos.filter(t => t.completed).length;
            const pending = monthTodos.filter(t => !t.completed).length;
            const overdue = monthTodos.filter(t => !t.completed && t.dueDate < now.toISOString().split('T')[0]).length;
            
            document.getElementById('monthTotalTasks').textContent = monthTodos.length;
            document.getElementById('monthCompletedTasks').textContent = completed;
            document.getElementById('monthPendingTasks').textContent = pending;
            document.getElementById('monthOverdueTasks').textContent = overdue;
            
            // Category Summary
            const categorySummary = document.getElementById('categorySummary');
            categorySummary.innerHTML = '';
            
            const categories = {
                work: { icon: 'üíº', name: '‡∏á‡∏≤‡∏ô', color: '#3b82f6' },
                personal: { icon: 'üë§', name: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß', color: '#8b5cf6' },
                shopping: { icon: 'üõí', name: '‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á', color: '#f59e0b' },
                health: { icon: 'üí™', name: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', color: '#10b981' },
                study: { icon: 'üìö', name: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', color: '#ec4899' }
            };
            
            Object.entries(categories).forEach(([key, cat]) => {
                const catTodos = monthTodos.filter(t => t.category === key);
                const catCompleted = catTodos.filter(t => t.completed).length;
                const percentage = catTodos.length > 0 ? Math.round((catCompleted / catTodos.length) * 100) : 0;
                
                const item = document.createElement('div');
                item.className = 'summary-item';
                item.innerHTML = `
                    <div class="summary-item-label">
                        <span>${cat.icon}</span>
                        <span>${cat.name}</span>
                    </div>
                    <div class="summary-item-value">${catCompleted}/${catTodos.length}</div>
                `;
                
                if (catTodos.length > 0) {
                    const bar = document.createElement('div');
                    bar.className = 'summary-item-bar';
                    bar.innerHTML = `<div class="summary-item-bar-fill" style="width: ${percentage}%; background: ${cat.color};"></div>`;
                    item.appendChild(bar);
                }
                
                categorySummary.appendChild(item);
            });
            
            // Branch Summary
            const branchSummary = document.getElementById('branchSummary');
            branchSummary.innerHTML = '';
            
            const allBranches = ['B011', 'B016', 'B018', 'B024', ...customBranches];
            const branchCounts = {};
            
            allBranches.forEach(branch => {
                const branchTodos = monthTodos.filter(t => t.branches && t.branches.includes(branch));
                const branchCompleted = branchTodos.filter(t => t.completed).length;
                
                if (branchTodos.length > 0) {
                    branchCounts[branch] = { total: branchTodos.length, completed: branchCompleted };
                }
            });
            
            if (Object.keys(branchCounts).length === 0) {
                branchSummary.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤</div>';
            } else {
                Object.entries(branchCounts).forEach(([branch, counts]) => {
                    const percentage = Math.round((counts.completed / counts.total) * 100);
                    const displayName = branchNames[branch] || branch;
                    
                    const item = document.createElement('div');
                    item.className = 'summary-item';
                    item.innerHTML = `
                        <div class="summary-item-label">
                            <span>üè¢</span>
                            <span>${displayName}</span>
                        </div>
                        <div class="summary-item-value">${counts.completed}/${counts.total}</div>
                    `;
                    
                    const bar = document.createElement('div');
                    bar.className = 'summary-item-bar';
                    bar.innerHTML = `<div class="summary-item-bar-fill" style="width: ${percentage}%;"></div>`;
                    item.appendChild(bar);
                    
                    branchSummary.appendChild(item);
                });
            }

            // Update Leave Summary in Dashboard
            const monthDayOffs = dayOffs.filter(d => d >= firstDay && d <= lastDay).length;
            const monthLeaves = leaveDays.filter(l => l.date >= firstDay && l.date <= lastDay);
            const holidayCount = monthLeaves.filter(l => l.type === 'holiday').length;
            const vacationCount = monthLeaves.filter(l => l.type === 'vacation').length;
            const sickCount = monthLeaves.filter(l => l.type === 'sick').length;
            const personalCount = monthLeaves.filter(l => l.type === 'personal').length;

            const dayOffEl = document.getElementById('summaryDayOff');
            const holidayEl = document.getElementById('summaryHoliday');
            const vacationEl = document.getElementById('summaryVacation');
            const sickEl = document.getElementById('summarySick');
            const personalEl = document.getElementById('summaryPersonal');

            if (dayOffEl) dayOffEl.textContent = monthDayOffs;
            if (holidayEl) holidayEl.textContent = holidayCount;
            if (vacationEl) vacationEl.textContent = vacationCount;
            if (sickEl) sickEl.textContent = sickCount;
            if (personalEl) personalEl.textContent = personalCount;
        }

        // Branch Functions
        function loadCustomBranches() {
            customBranches.forEach(branch => {
                addBranchOption(branch);
            });
        }

        function toggleBranch(branchCode) {
            event.stopPropagation();
            const checkbox = document.getElementById(`branch-${branchCode}`);
            checkbox.checked = !checkbox.checked;
            
            const option = checkbox.closest('.branch-option');
            if (checkbox.checked) {
                option.classList.add('selected');
                if (!selectedBranches.includes(branchCode)) {
                    selectedBranches.push(branchCode);
                }
            } else {
                option.classList.remove('selected');
                selectedBranches = selectedBranches.filter(b => b !== branchCode);
            }
            
            updateBranchTimeDisplay();
        }

        function addCustomBranch() {
            const input = document.getElementById('customBranchInput');
            const branchCode = input.value.trim().toUpperCase();
            
            if (!branchCode) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤', 'error');
                return;
            }
            
            const allBranches = ['B011', 'B016', 'B018', 'B024', ...customBranches];
            if (allBranches.includes(branchCode)) {
                showToast('‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            customBranches.push(branchCode);
            localStorage.setItem('customBranches', JSON.stringify(customBranches));
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
            branchNames[branchCode] = branchCode;
            localStorage.setItem('branchNames', JSON.stringify(branchNames));
            
            addBranchOption(branchCode);
            input.value = '';
            showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï branch selector ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            updateBranchSelectors();
        }

        function addBranchOption(branchCode) {
            const grid = document.getElementById('branchGrid');
            const option = document.createElement('div');
            option.className = 'branch-option';
            option.onclick = () => toggleBranch(branchCode);
            option.innerHTML = `
                <input type="checkbox" id="branch-${branchCode}" value="${branchCode}">
                <label for="branch-${branchCode}">${branchCode}</label>
            `;
            grid.appendChild(option);
        }

        function updateBranchSelectors() {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
            updateBranchTimeDisplay();
        }

        function updateBranchTimeDisplay() {
            const display = document.getElementById('branchTimeDisplay');
            const timeStart = document.getElementById('dueTimeStartInput').value;
            
            if (selectedBranches.length === 0) {
                display.innerHTML = 'üí° ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô';
                return;
            }
            
            if (!timeStart) {
                display.innerHTML = `üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <strong>${selectedBranches.join(', ')}</strong> | ‚è∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô`;
                return;
            }
            
            display.innerHTML = `üè¢ <strong>${selectedBranches.join(', ')}</strong> | ‚è∞ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô: <strong>${timeStart}</strong>`;
        }

        // Custom Category Functions
        function loadCustomCategories() {
            renderCustomCategoryList();
            updateCategorySelectors();
        }

        function addCustomCategory() {
            const iconInput = document.getElementById('customCategoryIcon');
            const nameInput = document.getElementById('customCategoryName');
            
            const icon = iconInput.value.trim() || 'üìù';
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
                return;
            }
            
            const key = name.toLowerCase().replace(/\s+/g, '_');
            
            // Check if already exists
            const exists = customCategories.some(c => c.key === key) || 
                          ['work', 'personal', 'shopping', 'health', 'study'].includes(key);
            
            if (exists) {
                showToast('‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            const newCategory = {
                key: key,
                icon: icon,
                name: name,
                color: getRandomColor()
            };
            
            customCategories.push(newCategory);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            renderCustomCategoryList();
            updateCategorySelectors();
            
            iconInput.value = '';
            nameInput.value = '';
            
            showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        }

        function deleteCustomCategory(key) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ?')) return;
            
            customCategories = customCategories.filter(c => c.key !== key);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            // Update todos that use this category to 'personal'
            todos.forEach(todo => {
                if (todo.category === key) {
                    todo.category = 'personal';
                }
            });
            saveTodos();
            
            renderCustomCategoryList();
            updateCategorySelectors();
            renderTodos();
            renderDashboardSummary();
            
            showToast('üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function renderCustomCategoryList() {
            const list = document.getElementById('customCategoryList');
            
            if (customCategories.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á</div>';
                return;
            }
            
            list.innerHTML = '';
            customCategories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'custom-category-item';
                item.innerHTML = `
                    <div class="custom-category-info">
                        <span class="custom-category-icon">${cat.icon}</span>
                        <span class="custom-category-name">${cat.name}</span>
                    </div>
                    <div class="custom-category-actions">
                        <button class="icon-btn delete" onclick="deleteCustomCategory('${cat.key}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function updateCategorySelectors() {
            // Update category tags
            const categoryTags = document.querySelector('.category-tags');
            if (categoryTags) {
                // Remove old custom categories
                categoryTags.querySelectorAll('.category-tag.custom').forEach(el => el.remove());
                
                // Add custom categories
                customCategories.forEach(cat => {
                    const tag = document.createElement('div');
                    tag.className = `category-tag custom ${cat.key}`;
                    tag.onclick = () => selectCategory(cat.key);
                    tag.innerHTML = `${cat.icon} ${cat.name}`;
                    tag.style.background = `linear-gradient(135deg, ${cat.color}, ${adjustColor(cat.color, -20)})`;
                    categoryTags.appendChild(tag);
                });
            }
            
            // Update edit modal category selector
            const editSelect = document.getElementById('editTodoCategory');
            if (editSelect) {
                // Remove old custom options
                editSelect.querySelectorAll('option.custom').forEach(el => el.remove());
                
                // Add custom categories
                customCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.className = 'custom';
                    option.value = cat.key;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    editSelect.appendChild(option);
                });
            }
            
            // Update bulk add default category selector
            const bulkSelect = document.getElementById('bulkDefaultCategory');
            if (bulkSelect) {
                // Get edited default categories
                const defaultCategoryEdits = JSON.parse(localStorage.getItem('defaultCategoryEdits')) || {};
                const hiddenCategories = JSON.parse(localStorage.getItem('hiddenCategories')) || [];
                
                // Update default category options with edited values
                const defaultCategories = {
                    'work': { icon: 'üíº', name: '‡∏á‡∏≤‡∏ô' },
                    'personal': { icon: 'üë§', name: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' },
                    'shopping': { icon: 'üõí', name: '‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á' },
                    'health': { icon: 'üí™', name: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' },
                    'study': { icon: 'üìö', name: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' }
                };
                
                Object.keys(defaultCategories).forEach(key => {
                    const option = bulkSelect.querySelector(`option[value="${key}"]`);
                    if (option) {
                        if (hiddenCategories.includes(key)) {
                            // Hide if deleted
                            option.style.display = 'none';
                        } else {
                            option.style.display = 'block';
                            // Update with edited values
                            if (defaultCategoryEdits[key]) {
                                option.textContent = `${defaultCategoryEdits[key].icon} ${defaultCategoryEdits[key].name}`;
                            } else {
                                option.textContent = `${defaultCategories[key].icon} ${defaultCategories[key].name}`;
                            }
                        }
                    }
                });
                
                // Remove old custom options
                bulkSelect.querySelectorAll('option.custom').forEach(el => el.remove());
                
                // Add custom categories
                customCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.className = 'custom';
                    option.value = cat.key;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    bulkSelect.appendChild(option);
                });
            }
            
            // Update sidebar categories
            updateSidebarCategories();
        }

        function updateSidebarCategories() {
            // Load default category edits
            const defaultCategoryEdits = JSON.parse(localStorage.getItem('defaultCategoryEdits')) || {};
            const hiddenCategories = JSON.parse(localStorage.getItem('hiddenCategories')) || [];
            
            // Update default categories in sidebar
            const defaultCategories = {
                'work': { icon: 'üíº', name: '‡∏á‡∏≤‡∏ô' },
                'personal': { icon: 'üë§', name: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' },
                'shopping': { icon: 'üõí', name: '‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á' },
                'health': { icon: 'üí™', name: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' },
                'study': { icon: 'üìö', name: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' }
            };
            
            Object.keys(defaultCategories).forEach(key => {
                const sidebarItem = document.querySelector(`.sidebar-item[data-section="${key}"]`);
                if (sidebarItem) {
                    // Hide if in hidden list
                    if (hiddenCategories.includes(key)) {
                        sidebarItem.style.display = 'none';
                    } else {
                        sidebarItem.style.display = 'flex';
                        
                        const iconSpan = sidebarItem.querySelector('.sidebar-item-icon');
                        const titleSpan = sidebarItem.querySelector('.sidebar-item-title');
                        
                        if (defaultCategoryEdits[key]) {
                            // Use edited values
                            if (iconSpan) iconSpan.textContent = defaultCategoryEdits[key].icon;
                            if (titleSpan) titleSpan.textContent = defaultCategoryEdits[key].name;
                        } else {
                            // Use default values
                            if (iconSpan) iconSpan.textContent = defaultCategories[key].icon;
                            if (titleSpan) titleSpan.textContent = defaultCategories[key].name;
                        }
                    }
                }
            });
            
            // Render custom categories
            const customContainer = document.getElementById('customCategoriesSidebar');
            if (customContainer) {
                customContainer.innerHTML = '';
                
                customCategories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'sidebar-item';
                    item.setAttribute('data-section', cat.key);
                    item.onclick = () => navigateTo(cat.key);
                    
                    item.innerHTML = `
                        <div class="sidebar-item-content">
                            <span class="sidebar-item-icon">${cat.icon}</span>
                            <div class="sidebar-item-text">
                                <span class="sidebar-item-title">${cat.name}</span>
                            </div>
                        </div>
                        <span class="sidebar-item-badge" id="sidebar${cat.key}Todos">0</span>
                    `;
                    
                    customContainer.appendChild(item);
                });
                
                // Update counts for custom categories
                updateSidebarCounts();
            }
        }

        function getRandomColor() {
            const colors = [
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', 
                '#10b981', '#06b6d4', '#f43f5e', '#8b5cf6'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        // Branch Visit Functions
        function addBranchVisit() {
            const branch = document.getElementById('branchVisitBranch').value;
            const date = document.getElementById('branchVisitDate').value;
            const time = document.getElementById('branchVisitTime').value;

            if (!branch) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤', 'error');
                return;
            }

            if (!date) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
                return;
            }

            if (!time) {
                showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', 'error');
                return;
            }

            const visit = {
                id: Date.now(),
                branch: branch,
                date: date,
                time: time,
                createdAt: new Date().toISOString()
            };

            branchVisits.push(visit);
            saveBranchVisits();
            renderCalendar();
            renderWeekPlan();
            renderDashboardSummary();

            // Clear form
            document.getElementById('branchVisitBranch').value = '';
            document.getElementById('branchVisitDate').value = '';
            document.getElementById('branchVisitTime').value = '';

            showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤ ${branch} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        }

        function deleteBranchVisit(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ?')) return;

            branchVisits = branchVisits.filter(v => v.id !== id);
            saveBranchVisits();
            renderCalendar();

            showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        // Edit Branch Visit Functions
        let currentEditBranchVisitId = null;

        function editBranchVisit(id) {
            const visit = branchVisits.find(v => v.id === id);
            if (!visit) return;

            currentEditBranchVisitId = id;

            // Populate form
            const branchSelect = document.getElementById('editBranchVisitBranch');
            branchSelect.value = visit.branch;
            
            // Add custom branches to select
            const allBranches = ['B011', 'B016', 'B018', 'B024', ...customBranches];
            branchSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';
            allBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branchNames[branch] || branch;
                if (branch === visit.branch) option.selected = true;
                branchSelect.appendChild(option);
            });

            document.getElementById('editBranchVisitDate').value = visit.date;
            document.getElementById('editBranchVisitTime').value = visit.time;

            // Show modal
            document.getElementById('editBranchModal').classList.add('active');
        }

        function saveEditedBranchVisit() {
            if (!currentEditBranchVisitId) return;

            const visit = branchVisits.find(v => v.id === currentEditBranchVisitId);
            if (!visit) return;

            const branch = document.getElementById('editBranchVisitBranch').value;
            const date = document.getElementById('editBranchVisitDate').value;
            const time = document.getElementById('editBranchVisitTime').value;

            if (!branch) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤', 'error');
                return;
            }

            if (!date) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
                return;
            }

            if (!time) {
                showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô', 'error');
                return;
            }

            // Update visit
            visit.branch = branch;
            visit.date = date;
            visit.time = time;

            saveBranchVisits();
            renderCalendar();
            renderWeekPlan();
            renderDashboardSummary();
            closeEditBranchModal();

            showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }

        function deleteEditedBranchVisit() {
            if (!currentEditBranchVisitId) return;

            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ?')) return;

            branchVisits = branchVisits.filter(v => v.id !== currentEditBranchVisitId);
            saveBranchVisits();
            renderCalendar();
            closeEditBranchModal();

            showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function closeEditBranchModal(event) {
            if (!event || event.target.id === 'editBranchModal') {
                document.getElementById('editBranchModal').classList.remove('active');
                currentEditBranchVisitId = null;
            }
        }

        function saveBranchVisits() {
            localStorage.setItem('branchVisits', JSON.stringify(branchVisits));
        }

        function updateBranchVisitSelector() {
            const select = document.getElementById('branchVisitBranch');
            if (!select) return;

            // Get current value to restore after update
            const currentValue = select.value;

            // Clear and rebuild all options
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';

            // Add all branches (default + custom) with their display names
            const allBranches = ['B011', 'B016', 'B018', 'B024','B012','B046','OFFICE', ...customBranches];
            allBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branchNames[branch] || branch; // Use edited name if available
                select.appendChild(option);
            });

            // Restore previous selection if it still exists
            if (currentValue && allBranches.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Settings Modal Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            renderSettingsBranchList();
            renderSettingsCategoryList();
            
            // Close sidebar on mobile
            if (window.innerWidth <= 1024) {
                toggleSidebar();
            }
        }

        function openQuickManageBranches() {
            openSettings();
            // Auto scroll to branch section
            setTimeout(() => {
                const branchSection = document.querySelector('.settings-section');
                if (branchSection) {
                    branchSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        function openQuickManageCategories() {
            openSettings();
            // Auto scroll to category section
            setTimeout(() => {
                const categorySection = document.querySelectorAll('.settings-section')[1]; // Second section
                if (categorySection) {
                    categorySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        function closeSettings(event) {
            if (!event || event.target.id === 'settingsModal') {
                document.getElementById('settingsModal').classList.remove('active');
                
                // Update all dropdowns after closing settings
                updateBranchVisitSelector();
                updateCategorySelectors();
            }
        }

        function renderSettingsBranchList() {
            const list = document.getElementById('settingsBranchList');
            const allBranches = ['B011', 'B016', 'B018', 'B024','B012','B046','OFFICE', ...customBranches];
            
            if (allBranches.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤</div>';
                return;
            }
            
            list.innerHTML = '';
            allBranches.forEach(branch => {
                const isDefault = ['B011', 'B016', 'B018', 'B024','B012','B046','OFFICE'].includes(branch);
                const displayName = branchNames[branch] || branch;
                const item = document.createElement('div');
                item.className = 'custom-category-item';
                item.innerHTML = `
                    <div class="custom-category-info">
                        <span class="custom-category-icon">üè¢</span>
                        <span class="custom-category-name" id="branch-name-${branch}">${displayName}</span>
                        ${isDefault ? '<span style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 8px;">(‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</span>' : ''}
                    </div>
                    <div class="custom-category-actions">
                        <button class="icon-btn" onclick="editBranchName('${branch}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠">‚úèÔ∏è</button>
                        ${!isDefault ? `<button class="icon-btn delete" onclick="deleteCustomBranchFromSettings('${branch}')" title="‡∏•‡∏ö">üóëÔ∏è</button>` : ''}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function renderSettingsCategoryList() {
            const list = document.getElementById('settingsCategoryList');
            const hiddenCategories = JSON.parse(localStorage.getItem('hiddenCategories')) || [];
            
            // Show default categories
            const defaultCategories = [
                { key: 'work', icon: 'üíº', name: '‡∏á‡∏≤‡∏ô' },
                { key: 'personal', icon: 'üë§', name: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' },
                { key: 'shopping', icon: 'üõí', name: '‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á' },
                { key: 'health', icon: 'üí™', name: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' },
                { key: 'study', icon: 'üìö', name: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' }
            ];
            
            list.innerHTML = '';
            
            // Add default categories (now editable and deletable) - filter out hidden ones
            defaultCategories.forEach(cat => {
                // Skip if hidden
                if (hiddenCategories.includes(cat.key)) return;
                
                const item = document.createElement('div');
                item.className = 'custom-category-item';
                item.innerHTML = `
                    <div class="custom-category-info">
                        <span class="custom-category-icon" id="cat-icon-${cat.key}">${cat.icon}</span>
                        <span class="custom-category-name" id="cat-name-${cat.key}">${cat.name}</span>
                        <span style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 8px;">(‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</span>
                    </div>
                    <div class="custom-category-actions">
                        <button class="icon-btn" onclick="editCategory('${cat.key}', '${cat.icon}', '${cat.name}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                        <button class="icon-btn delete" onclick="deleteDefaultCategory('${cat.key}', '${cat.name}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(item);
            });
            
            // Add custom categories
            customCategories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'custom-category-item';
                item.innerHTML = `
                    <div class="custom-category-info">
                        <span class="custom-category-icon" id="cat-icon-${cat.key}">${cat.icon}</span>
                        <span class="custom-category-name" id="cat-name-${cat.key}">${cat.name}</span>
                    </div>
                    <div class="custom-category-actions">
                        <button class="icon-btn" onclick="editCategory('${cat.key}', '${cat.icon}', '${cat.name}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                        <button class="icon-btn delete" onclick="deleteCustomCategoryFromSettings('${cat.key}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function addCustomBranchFromSettings() {
            const input = document.getElementById('settingsBranchInput');
            const branchCode = input.value.trim().toUpperCase();
            
            if (!branchCode) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤', 'error');
                return;
            }
            
            const allBranches = ['B011', 'B016', 'B018', 'B024', ...customBranches];
            if (allBranches.includes(branchCode)) {
                showToast('‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            customBranches.push(branchCode);
            localStorage.setItem('customBranches', JSON.stringify(customBranches));
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
            branchNames[branchCode] = branchCode;
            localStorage.setItem('branchNames', JSON.stringify(branchNames));
            
            addBranchOption(branchCode);
            renderSettingsBranchList();
            updateCategorySelectors();
            updateBranchVisitSelector();
            
            input.value = '';
            showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        }

        function deleteCustomBranchFromSettings(branchCode) {
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}?`)) return;
            
            customBranches = customBranches.filter(b => b !== branchCode);
            localStorage.setItem('customBranches', JSON.stringify(customBranches));
            
            // Remove from branch grid
            const branchOption = document.getElementById(`branch-${branchCode}`);
            if (branchOption) {
                branchOption.closest('.branch-option').remove();
            }
            
            // Update todos that use this branch
            todos.forEach(todo => {
                if (todo.branches && todo.branches.includes(branchCode)) {
                    todo.branches = todo.branches.filter(b => b !== branchCode);
                }
            });
            saveTodos();
            
            // Remove branch visits that use this branch
            branchVisits = branchVisits.filter(v => v.branch !== branchCode);
            saveBranchVisits();
            
            renderSettingsBranchList();
            renderDashboardSummary();
            renderTodos();
            renderCalendar();
            renderWeekPlan();
            updateBranchVisitSelector(); // Update branch visit dropdown
            
            showToast(`üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        }

        function addCustomCategoryFromSettings() {
            const iconInput = document.getElementById('settingsCategoryIcon');
            const nameInput = document.getElementById('settingsCategoryName');
            
            const icon = iconInput.value.trim() || 'üìù';
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'error');
                return;
            }
            
            const key = name.toLowerCase().replace(/\s+/g, '_');
            
            // Check if already exists
            const exists = customCategories.some(c => c.key === key) || 
                          ['work', 'personal', 'shopping', 'health', 'study'].includes(key);
            
            if (exists) {
                showToast('‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            const newCategory = {
                key: key,
                icon: icon,
                name: name,
                color: getRandomColor()
            };
            
            customCategories.push(newCategory);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            renderSettingsCategoryList();
            updateCategorySelectors();
            
            iconInput.value = '';
            nameInput.value = '';
            
            showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        }

        function deleteCustomCategoryFromSettings(key) {
            const category = customCategories.find(c => c.key === key);
            if (!category) return;
            
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${category.name}"?`)) return;
            
            customCategories = customCategories.filter(c => c.key !== key);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            // Update todos that use this category to 'personal'
            todos.forEach(todo => {
                if (todo.category === key) {
                    todo.category = 'personal';
                }
            });
            saveTodos();
            
            renderSettingsCategoryList();
            updateCategorySelectors();
            renderTodos();
            renderDashboardSummary();
            
            showToast(`üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${category.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        }

        function deleteDefaultCategory(key, name) {
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${name}" ‡∏à‡∏≤‡∏Å Sidebar?\n\n(‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß")`)) return;
            
            // Hide from sidebar by adding to hidden list
            let hiddenCategories = JSON.parse(localStorage.getItem('hiddenCategories')) || [];
            if (!hiddenCategories.includes(key)) {
                hiddenCategories.push(key);
                localStorage.setItem('hiddenCategories', JSON.stringify(hiddenCategories));
            }
            
            // Update todos that use this category to 'personal'
            todos.forEach(todo => {
                if (todo.category === key) {
                    todo.category = 'personal';
                }
            });
            saveTodos();
            
            // Hide from sidebar
            const sidebarItem = document.querySelector(`.sidebar-item[data-section="${key}"]`);
            if (sidebarItem) {
                sidebarItem.style.display = 'none';
            }
            
            renderSettingsCategoryList();
            updateCategorySelectors();
            renderTodos();
            renderDashboardSummary();
            
            showToast(`üóëÔ∏è ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        }

        function editBranchName(branchCode) {
            const currentName = branchNames[branchCode] || branchCode;
            const newName = prompt(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}:`, currentName);
            
            if (newName && newName.trim()) {
                branchNames[branchCode] = newName.trim();
                localStorage.setItem('branchNames', JSON.stringify(branchNames));
                
                document.getElementById(`branch-name-${branchCode}`).textContent = newName.trim();
                showToast(`‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                
                // Refresh displays
                updateBranchVisitSelector(); // Update branch visit dropdown
                renderCalendar();
                renderTodos();
                renderWeekPlan();
            }
        }

        function editCategory(key, currentIcon, currentName) {
            const newIcon = prompt(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Icon ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${currentIcon}):`, currentIcon);
            if (!newIcon) return;
            
            const newName = prompt(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${currentName}):`, currentName);
            if (!newName) return;
            
            // Check if default category
            const defaultKeys = ['work', 'personal', 'shopping', 'health', 'study'];
            if (defaultKeys.includes(key)) {
                // Update in memory (not saved as custom)
                document.getElementById(`cat-icon-${key}`).textContent = newIcon.trim();
                document.getElementById(`cat-name-${key}`).textContent = newName.trim();
                
                // Save to localStorage for default categories
                let defaultCategoryEdits = JSON.parse(localStorage.getItem('defaultCategoryEdits')) || {};
                defaultCategoryEdits[key] = { icon: newIcon.trim(), name: newName.trim() };
                localStorage.setItem('defaultCategoryEdits', JSON.stringify(defaultCategoryEdits));
            } else {
                // Update custom category
                const cat = customCategories.find(c => c.key === key);
                if (cat) {
                    cat.icon = newIcon.trim();
                    cat.name = newName.trim();
                    localStorage.setItem('customCategories', JSON.stringify(customCategories));
                    
                    document.getElementById(`cat-icon-${key}`).textContent = newIcon.trim();
                    document.getElementById(`cat-name-${key}`).textContent = newName.trim();
                }
            }
            
            updateCategorySelectors();
            renderTodos();
            renderDashboardSummary();
            showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }

        // Sidebar Functions
        function checkSidebarVisibility() {
            const toggle = document.getElementById('sidebarToggle');
            if (window.innerWidth <= 1024) {
                toggle.classList.add('show');
            } else {
                toggle.classList.remove('show');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebarNav');
            const overlay = document.getElementById('sidebarOverlay');
            const mainWrapper = document.getElementById('mainWrapper');
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('show');
            } else {
                sidebar.classList.toggle('collapsed');
                mainWrapper.classList.toggle('full-width');
            }
        }

        function navigateTo(section) {
            currentSection = section;
            
            // Update active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            // Close sidebar on mobile
            if (window.innerWidth <= 1024) {
                toggleSidebar();
            }
            
            // Handle navigation
            switch(section) {
                case 'dashboard':
                    currentFilter = 'all';
                    currentView = 'list';
                    document.getElementById('todoSections').style.display = 'grid';
                    document.getElementById('calendarView').classList.remove('active');
                    filterTodos('all');
                    break;
                    
                case 'today':
                    filterByDate('today');
                    break;
                    
                case 'upcoming':
                    filterByDate('upcoming');
                    break;
                    
                case 'overdue':
                    filterByDate('overdue');
                    break;
                    
                case 'calendar':
                    switchView('calendar');
                    break;
                    
                case 'recurring':
                    filterRecurring();
                    break;
                    
                case 'completed':
                    filterTodos('completed');
                    break;
                    
                case 'work':
                case 'personal':
                case 'shopping':
                case 'health':
                case 'study':
                    filterByCategory(section);
                    break;
            }
            
            // Update view buttons
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            if (section === 'calendar') {
                document.querySelector('[onclick*="calendar"]').classList.add('active');
            } else {
                document.querySelector('[onclick*="list"]').classList.add('active');
            }
        }

        function filterByDate(type) {
            currentView = 'list';
            document.getElementById('todoSections').style.display = 'grid';
            document.getElementById('calendarView').classList.remove('active');
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            let filtered = [...todos];
            
            switch(type) {
                case 'today':
                    filtered = filtered.filter(t => t.dueDate === todayStr);
                    break;
                    
                case 'upcoming':
                    const fiveDaysLater = new Date(today);
                    fiveDaysLater.setDate(fiveDaysLater.getDate() + 5);
                    const fiveDaysLaterStr = fiveDaysLater.toISOString().split('T')[0];
                    filtered = filtered.filter(t => t.dueDate > todayStr && t.dueDate <= fiveDaysLaterStr);
                    break;
                    
                case 'overdue':
                    filtered = filtered.filter(t => t.dueDate && t.dueDate < todayStr && !t.completed);
                    break;
            }
            
            renderFilteredTodos(filtered, type);
        }

        function filterByCategory(category) {
            currentView = 'list';
            document.getElementById('todoSections').style.display = 'grid';
            document.getElementById('calendarView').classList.remove('active');
            
            const filtered = todos.filter(t => t.category === category);
            renderFilteredTodos(filtered, category);
        }

        function filterRecurring() {
            currentView = 'list';
            document.getElementById('todoSections').style.display = 'grid';
            document.getElementById('calendarView').classList.remove('active');
            
            const filtered = todos.filter(t => t.recurring && !t.parentId);
            renderFilteredTodos(filtered, 'recurring');
        }

        function renderFilteredTodos(filtered, type) {
            const sections = document.getElementById('todoSections');
            sections.innerHTML = '';
            
            const titles = {
                today: '‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
                upcoming: '5 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤',
                overdue: '‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
                work: '‡∏á‡∏≤‡∏ô üíº',
                personal: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß üë§',
                shopping: '‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á üõí',
                health: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û üí™',
                study: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô üìö',
                recurring: '‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ üîÑ'
            };
            
            if (filtered.length === 0) {
                sections.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>
                    </div>
                `;
            } else {
                const active = filtered.filter(t => !t.completed);
                const completed = filtered.filter(t => t.completed);
                
                if (active.length > 0) {
                    sections.appendChild(createSection(titles[type] || '‡∏á‡∏≤‡∏ô', active, type === 'overdue' ? '‚ö†Ô∏è' : 'üìã'));
                }
                
                if (completed.length > 0) {
                    sections.appendChild(createSection('‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', completed, '‚úÖ'));
                }
            }
        }

        function updateSidebarCounts() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            const weekLater = new Date(today);
            weekLater.setDate(weekLater.getDate() + 7);
            const weekLaterStr = weekLater.toISOString().split('T')[0];
            
            // Total
            document.getElementById('sidebarTotalTodos').textContent = todos.filter(t => !t.completed).length;
            
            // Today
            document.getElementById('sidebarTodayTodos').textContent = 
                todos.filter(t => t.dueDate === todayStr && !t.completed).length;
            
            // Upcoming
            document.getElementById('sidebarUpcomingTodos').textContent = 
                todos.filter(t => t.dueDate > todayStr && t.dueDate <= weekLaterStr && !t.completed).length;
            
            // Overdue
            document.getElementById('sidebarOverdueTodos').textContent = 
                todos.filter(t => t.dueDate && t.dueDate < todayStr && !t.completed).length;
            
            // Recurring
            document.getElementById('sidebarRecurringTodos').textContent = 
                todos.filter(t => t.recurring && !t.parentId).length;
            
            // Categories
            document.getElementById('sidebarWorkTodos').textContent = 
                todos.filter(t => t.category === 'work' && !t.completed).length;
            document.getElementById('sidebarPersonalTodos').textContent = 
                todos.filter(t => t.category === 'personal' && !t.completed).length;
            document.getElementById('sidebarShoppingTodos').textContent = 
                todos.filter(t => t.category === 'shopping' && !t.completed).length;
            document.getElementById('sidebarHealthTodos').textContent = 
                todos.filter(t => t.category === 'health' && !t.completed).length;
            document.getElementById('sidebarStudyTodos').textContent = 
                todos.filter(t => t.category === 'study' && !t.completed).length;
            
            // Custom categories
            customCategories.forEach(cat => {
                const badge = document.getElementById(`sidebar${cat.key}Todos`);
                if (badge) {
                    badge.textContent = todos.filter(t => t.category === cat.key && !t.completed).length;
                }
            });
            
            // Completed
            document.getElementById('sidebarCompletedTodos').textContent = 
                todos.filter(t => t.completed).length;
        }

        // Add Todo
        function addTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            if (!text) return;

            const priority = document.getElementById('prioritySelect').value;
            const dueDate = document.getElementById('dueDateInput').value;
            const timeStart = document.getElementById('dueTimeStartInput').value;
            const timeEnd = document.getElementById('dueTimeEndInput').value;
            const isRecurring = document.getElementById('recurringCheckbox').checked;

            // Validate branch and time
            if (selectedBranches.length > 0 && !timeStart) {
                showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤', 'error');
                return;
            }

            const todo = {
                id: Date.now(),
                text: text,
                completed: false,
                priority: priority,
                category: currentCategory || 'personal',
                dueDate: dueDate,
                timeStart: timeStart,
                timeEnd: timeEnd,
                branches: [...selectedBranches],
                createdAt: new Date().toISOString()
            };

            // Add recurring configuration
            if (isRecurring) {
                todo.recurring = {
                    type: document.getElementById('recurringType').value,
                    interval: parseInt(document.getElementById('recurringInterval').value) || 1,
                    startDate: document.getElementById('recurringStartDate').value || dueDate,
                    endDate: document.getElementById('recurringEndDate').value || null,
                    weekdays: [...selectedWeekdays],
                    lastGenerated: new Date().toISOString().split('T')[0]
                };
            }

            todos.unshift(todo);
            saveTodos();
            
            // Generate recurring instances if needed
            if (isRecurring) {
                generateRecurringTasks();
            }
            
            refreshAllViews();

            input.value = '';
            document.getElementById('dueTimeStartInput').value = '';
            document.getElementById('dueTimeEndInput').value = '';
            document.getElementById('recurringCheckbox').checked = false;
            document.getElementById('recurringOptions').classList.remove('show');
            selectedWeekdays = [];
            selectedBranches = [];
            currentCategory = null;
            
            // Clear branch selection
            document.querySelectorAll('.branch-option').forEach(opt => {
                opt.classList.remove('selected');
                const checkbox = opt.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
            updateBranchTimeDisplay();
            
            document.querySelectorAll('.category-tag').forEach(tag => tag.classList.remove('active'));
        }

        // Toggle Todo
        function toggleTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                saveTodos();
                refreshAllViews();
            }
        }

        // Delete Todo
        function deleteTodo(id) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) {
                todos = todos.filter(t => t.id !== id);
                saveTodos();
                refreshAllViews();
            }
        }

        // Edit Todo
        let currentEditId = null;
        let editSelectedBranches = [];

        function editTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            currentEditId = id;
            editSelectedBranches = todo.branches ? [...todo.branches] : [];

            // Populate form
            document.getElementById('editTodoText').value = todo.text;
            document.getElementById('editTodoPriority').value = todo.priority;
            document.getElementById('editTodoCategory').value = todo.category;
            document.getElementById('editTodoDate').value = todo.dueDate || '';
            document.getElementById('editTodoTimeStart').value = todo.timeStart || '';
            document.getElementById('editTodoTimeEnd').value = todo.timeEnd || '';

            // Populate branch grid
            const editGrid = document.getElementById('editBranchGrid');
            editGrid.innerHTML = '';
            
            const allBranches = ['B011', 'B016', 'B018', 'B024', ...customBranches];
            allBranches.forEach(branch => {
                const isSelected = editSelectedBranches.includes(branch);
                const option = document.createElement('div');
                option.className = 'branch-option' + (isSelected ? ' selected' : '');
                option.onclick = () => toggleEditBranch(branch);
                option.innerHTML = `
                    <input type="checkbox" id="edit-branch-${branch}" value="${branch}" ${isSelected ? 'checked' : ''}>
                    <label for="edit-branch-${branch}">${branch}</label>
                `;
                editGrid.appendChild(option);
            });

            // Show modal
            document.getElementById('editModal').classList.add('active');
        }

        function toggleEditBranch(branchCode) {
            event.stopPropagation();
            const checkbox = document.getElementById(`edit-branch-${branchCode}`);
            checkbox.checked = !checkbox.checked;
            
            const option = checkbox.closest('.branch-option');
            if (checkbox.checked) {
                option.classList.add('selected');
                if (!editSelectedBranches.includes(branchCode)) {
                    editSelectedBranches.push(branchCode);
                }
            } else {
                option.classList.remove('selected');
                editSelectedBranches = editSelectedBranches.filter(b => b !== branchCode);
            }
        }

        function saveEditedTodo() {
            if (!currentEditId) return;

            const todo = todos.find(t => t.id === currentEditId);
            if (!todo) return;

            // Update todo
            todo.text = document.getElementById('editTodoText').value.trim();
            todo.priority = document.getElementById('editTodoPriority').value;
            todo.category = document.getElementById('editTodoCategory').value;
            todo.dueDate = document.getElementById('editTodoDate').value;
            todo.timeStart = document.getElementById('editTodoTimeStart').value;
            todo.timeEnd = document.getElementById('editTodoTimeEnd').value;
            todo.branches = [...editSelectedBranches];

            if (!todo.text) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô', 'error');
                return;
            }

            saveTodos();
            refreshAllViews();

            closeEditModal();
            showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }

        function closeEditModal(event) {
            if (!event || event.target.id === 'editModal') {
                document.getElementById('editModal').classList.remove('active');
                currentEditId = null;
                editSelectedBranches = [];
            }
        }

        // Filter Todos
        function filterTodos(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderTodos();
        }

        // Search Todos
        document.getElementById('searchInput').addEventListener('input', function(e) {
            renderTodos(e.target.value);
        });

        // Select Category
        function selectCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Render Todos
        function renderTodos(searchQuery = '') {
            let filtered = [...todos];

            // Apply search
            if (searchQuery) {
                filtered = filtered.filter(todo => 
                    todo.text.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }

            // Apply filter
            if (currentFilter === 'active') {
                filtered = filtered.filter(t => !t.completed);
            } else if (currentFilter === 'completed') {
                filtered = filtered.filter(t => t.completed);
            } else if (['high', 'medium', 'low'].includes(currentFilter)) {
                filtered = filtered.filter(t => t.priority === currentFilter);
            }

            // Group by status
            const active = filtered.filter(t => !t.completed);
            const completed = filtered.filter(t => t.completed);

            const sections = document.getElementById('todoSections');
            sections.innerHTML = '';

            // Active Todos Section
            if (active.length > 0 || currentFilter === 'all' || currentFilter === 'active') {
                sections.appendChild(createSection('‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥', active, '‚è≥'));
            }

            // Completed Todos Section
            if (completed.length > 0 || currentFilter === 'completed') {
                sections.appendChild(createSection('‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', completed, '‚úÖ'));
            }

            // Empty state
            if (filtered.length === 0) {
                sections.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        <p style="color: var(--text-secondary);">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                    </div>
                `;
            }
        }

        // Create Section
        function createSection(title, todos, icon) {
            const section = document.createElement('div');
            section.className = 'section fade-in';

            const header = `
                <div class="section-header">
                    <div class="section-title">
                        <span>${icon}</span>
                        <span>${title}</span>
                        <span class="section-count">${todos.length}</span>
                    </div>
                </div>
            `;

            const list = document.createElement('div');
            list.className = 'todo-list';

            todos.forEach(todo => {
                list.appendChild(createTodoItem(todo));
            });

            section.innerHTML = header;
            section.appendChild(list);

            return section;
        }

        // Create Todo Item
        function createTodoItem(todo) {
            const item = document.createElement('div');
            item.className = `todo-item ${todo.completed ? 'completed' : ''}`;

            const categoryIcons = {
                work: 'üíº',
                personal: 'üë§',
                shopping: 'üõí',
                health: 'üí™',
                study: 'üìö'
            };

            const isOverdue = todo.dueDate && new Date(todo.dueDate) < new Date() && !todo.completed;
            const timeDisplay = todo.timeStart && todo.timeEnd ? 
                `‚è∞ ${todo.timeStart}-${todo.timeEnd}` : 
                (todo.timeStart ? `‚è∞ ${todo.timeStart}` : '');
            const isRecurring = todo.recurring ? true : false;
            const recurringText = getRecurringText(todo.recurring);
            const branchDisplay = todo.branches && todo.branches.length > 0 ? 
                todo.branches.map(b => `<span class="branch-badge">üè¢ ${b}</span>`).join(' ') : '';

            item.innerHTML = `
                <div class="checkbox-wrapper">
                    <div class="checkbox ${todo.completed ? 'checked' : ''}" onclick="toggleTodo(${todo.id})"></div>
                </div>
                <div class="todo-content">
                    <div class="todo-text">${todo.icon ? todo.icon + ' ' : ''}${todo.text}</div>
                    <div class="todo-meta">
                        <span class="category-tag ${todo.category}">${getCategoryIcon(todo.category)} ${getCategoryName(todo.category)}</span>
                        <span class="priority-badge priority-${todo.priority}">${getPriorityText(todo.priority)}</span>
                        ${isRecurring ? `<span class="recurring-badge">üîÑ ${recurringText}</span>` : ''}
                        ${branchDisplay}
                        ${todo.dueDate ? `<span class="due-date ${isOverdue ? 'overdue' : ''}">üìÖ ${formatDate(todo.dueDate)} ${timeDisplay}</span>` : ''}
                    </div>
                </div>
                <div class="todo-actions">
                    <button class="icon-btn" onclick="editTodo(${todo.id})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                    <button class="icon-btn delete" onclick="deleteTodo(${todo.id})" title="‡∏•‡∏ö">üóëÔ∏è</button>
                </div>
            `;

            return item;
        }

        // Update Stats
        function updateStats() {
            const total = todos.length;
            const completed = todos.filter(t => t.completed).length;
            const pending = total - completed;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTodos').textContent = total;
            document.getElementById('completedTodos').textContent = completed;
            document.getElementById('pendingTodos').textContent = pending;

            // Update progress bar
            const progressBar = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressPercentage');
            const completedCountEl = document.getElementById('completedCount');
            const totalCountEl = document.getElementById('totalCount');

            progressText.textContent = percentage + '%';
            progressBar.style.width = percentage + '%';
            completedCountEl.textContent = completed;
            totalCountEl.textContent = total;

            // Change color based on percentage
            progressBar.classList.remove('low', 'medium', 'high', 'complete');
            if (percentage === 100) {
                progressBar.classList.add('complete');
            } else if (percentage >= 70) {
                progressBar.classList.add('high');
            } else if (percentage >= 40) {
                progressBar.classList.add('medium');
            } else {
                progressBar.classList.add('low');
            }
        }

        // Helper Functions
        function getCategoryName(category) {
            const names = {
                work: '‡∏á‡∏≤‡∏ô',
                personal: '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß',
                shopping: '‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á',
                health: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                study: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
            };
            
            // Check custom categories
            const custom = customCategories.find(c => c.key === category);
            if (custom) return custom.name;
            
            return names[category] || category;
        }

        function getCategoryIcon(category) {
            const icons = {
                work: 'üíº',
                personal: 'üë§',
                shopping: 'üõí',
                health: 'üí™',
                study: 'üìö'
            };
            
            // Check custom categories
            const custom = customCategories.find(c => c.key === category);
            if (custom) return custom.icon;
            
            return icons[category] || 'üìù';
        }

        function getPriorityText(priority) {
            const texts = {
                high: '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å',
                medium: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
                low: '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ô‡πâ‡∏≠‡∏¢'
            };
            return texts[priority] || priority;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('th-TH', options);
        }

        function setDefaultDate() {
            const today = new Date();
            today.setDate(today.getDate() + 1);
            document.getElementById('dueDateInput').value = today.toISOString().split('T')[0];
        }

        // Clear Completed
        function clearCompleted() {
            const completedCount = todos.filter(t => t.completed).length;
            if (completedCount === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏•‡∏ö');
                return;
            }

            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ${completedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) {
                todos = todos.filter(t => !t.completed);
                saveTodos();
                renderTodos();
                updateStats();
            }
        }

        // Export/Import Functions
        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeExportMenu);
            }, 0);
        }

        function closeExportMenu(e) {
            const dropdown = document.getElementById('exportDropdown');
            const menu = document.querySelector('.export-menu');
            
            if (!menu.contains(e.target)) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeExportMenu);
            }
        }

        function exportToExcel() {
            // Prepare data for Excel
            const data = todos.map(todo => ({
                '‡∏á‡∏≤‡∏ô': todo.text,
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': todo.completed ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à',
                '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç': getPriorityText(todo.priority),
                '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': getCategoryName(todo.category),
                '‡∏™‡∏≤‡∏Ç‡∏≤': todo.branches && todo.branches.length > 0 ? todo.branches.join(', ') : '',
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': todo.dueDate ? formatDate(todo.dueDate) : '',
                '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°': todo.timeStart || '',
                '‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î': todo.timeEnd || '',
                '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠': new Date(todo.createdAt).toLocaleString('th-TH')
            }));

            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);

            // Set column widths
            ws['!cols'] = [
                { wch: 40 }, // ‡∏á‡∏≤‡∏ô
                { wch: 12 }, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                { wch: 15 }, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                { wch: 12 }, // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                { wch: 20 }, // ‡∏™‡∏≤‡∏Ç‡∏≤
                { wch: 15 }, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                { wch: 10 }, // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
                { wch: 10 }, // ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                { wch: 20 }  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, '‡∏á‡∏≤‡∏ô');

            // Add summary sheet
            const summary = [
                { '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': todos.length },
                { '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': todos.filter(t => t.completed).length },
                { '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': todos.filter(t => !t.completed).length },
                { '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': todos.filter(t => t.priority === 'high').length },
                { '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': todos.filter(t => t.priority === 'medium').length },
                { '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ô‡πâ‡∏≠‡∏¢', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': todos.filter(t => t.priority === 'low').length }
            ];
            const summaryWs = XLSX.utils.json_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, summaryWs, '‡∏™‡∏£‡∏∏‡∏õ');

            // Save file
            const fileName = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≤‡∏¢‡πÇ‡∏î‡∏°_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            toggleExportMenu();
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìä');
        }

        function exportToCSV() {
            const data = todos.map(todo => ({
                '‡∏á‡∏≤‡∏ô': todo.text,
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': todo.completed ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à',
                '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç': getPriorityText(todo.priority),
                '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': getCategoryName(todo.category),
                '‡∏™‡∏≤‡∏Ç‡∏≤': todo.branches && todo.branches.length > 0 ? todo.branches.join(', ') : '',
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': todo.dueDate || '',
                '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°': todo.timeStart || '',
                '‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î': todo.timeEnd || '',
                '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠': new Date(todo.createdAt).toLocaleString('th-TH')
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const csv = XLSX.utils.sheet_to_csv(ws);
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≤‡∏¢‡πÇ‡∏î‡∏°_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();

            toggleExportMenu();
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÑ');
        }

        function exportToJSON() {
            const dataStr = JSON.stringify(todos, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≤‡∏¢‡πÇ‡∏î‡∏°_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            toggleExportMenu();
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üíæ');
        }

        function importFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Read first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Convert to todos format
                    let imported = 0;
                    jsonData.forEach(row => {
                        // Handle both Thai and English headers
                        const text = row['‡∏á‡∏≤‡∏ô'] || row['Task'] || row['text'];
                        if (!text) return;

                        const completed = (row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || row['Status'] || row['completed']) === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' || 
                                        (row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || row['Status'] || row['completed']) === 'Completed' ||
                                        (row['completed'] === true);
                        
                        const priorityMap = {
                            '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å': 'high',
                            'High': 'high',
                            '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': 'medium',
                            'Medium': 'medium',
                            '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ô‡πâ‡∏≠‡∏¢': 'low',
                            'Low': 'low'
                        };
                        const priority = priorityMap[row['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'] || row['Priority'] || row['priority']] || 'medium';

                        const categoryMap = {
                            '‡∏á‡∏≤‡∏ô': 'work',
                            'Work': 'work',
                            '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß': 'personal',
                            'Personal': 'personal',
                            '‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á': 'shopping',
                            'Shopping': 'shopping',
                            '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û': 'health',
                            'Health': 'health',
                            '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': 'study',
                            'Study': 'study'
                        };
                        const category = categoryMap[row['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] || row['Category'] || row['category']] || 'personal';

                        // Parse date
                        let dueDate = row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || row['Date'] || row['dueDate'] || '';
                        if (dueDate && typeof dueDate === 'number') {
                            // Excel date serial number
                            const excelDate = XLSX.SSF.parse_date_code(dueDate);
                            dueDate = `${excelDate.y}-${String(excelDate.m).padStart(2, '0')}-${String(excelDate.d).padStart(2, '0')}`;
                        } else if (dueDate) {
                            // Try to parse string date
                            const parsedDate = new Date(dueDate);
                            if (!isNaN(parsedDate)) {
                                dueDate = parsedDate.toISOString().split('T')[0];
                            }
                        }

                        const todo = {
                            id: Date.now() + imported,
                            text: text,
                            completed: completed,
                            priority: priority,
                            category: category,
                            dueDate: dueDate,
                            dueTime: row['‡πÄ‡∏ß‡∏•‡∏≤'] || row['Time'] || row['dueTime'] || '',
                            createdAt: new Date().toISOString()
                        };

                        todos.push(todo);
                        imported++;
                    });

                    if (imported > 0) {
                        saveTodos();
                        renderTodos();
                        updateStats();
                        updateNotifications();
                        renderWeekPlan();
                        showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${imported} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£! ‚úÖ`);
                    } else {
                        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ ‚ùå', 'error');
                    }

                } catch (error) {
                    console.error('Import error:', error);
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‚ùå', 'error');
                }
            };

            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Reset input
            toggleExportMenu();
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? 'var(--danger)' : 'var(--success)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                font-weight: 600;
                animation: toastSlide 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastSlide 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Theme Toggle
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            applyTheme();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('themeIcon').textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Handle Enter Key
        function handleEnter(event) {
            if (event.key === 'Enter') {
                addTodo();
            }
        }

        // Save to LocalStorage
        function saveTodos() {
            localStorage.setItem('todos', JSON.stringify(todos));
        }

        function refreshAllViews() {
            updateSidebarCounts();
            renderDashboardSummary();
            renderTodos();
            updateStats();
            updateNotifications();
            renderWeekPlan();
            renderCalendar(); // Always refresh calendar
        }

        // Switch View
        function switchView(view) {
            currentView = view;
            
            // Update buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Toggle views
            if (view === 'list') {
                document.getElementById('todoSections').style.display = 'grid';
                document.getElementById('calendarView').classList.remove('active');
            } else {
                document.getElementById('todoSections').style.display = 'none';
                document.getElementById('calendarView').classList.add('active');
                renderCalendar();
            }
        }

        // Calendar Functions
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update title
            const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                              '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year + 543}`;

            // Calculate month stats
            const firstDayOfMonth = new Date(year, month, 1).toISOString().split('T')[0];
            const lastDayOfMonth = new Date(year, month + 1, 0).toISOString().split('T')[0];
            
            const monthTodos = todos.filter(t => t.dueDate >= firstDayOfMonth && t.dueDate <= lastDayOfMonth);
            const monthCompleted = monthTodos.filter(t => t.completed).length;
            const monthPending = monthTodos.length - monthCompleted;
            const monthDayOffs = dayOffs.filter(d => d >= firstDayOfMonth && d <= lastDayOfMonth).length;

            document.getElementById('calMonthTodos').textContent = monthTodos.length;
            document.getElementById('calMonthCompleted').textContent = monthCompleted;
            document.getElementById('calMonthPending').textContent = monthPending;
            document.getElementById('calMonthDayOff').textContent = monthDayOffs;

            // Calculate leave stats - ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á dayOffs ‡πÅ‡∏•‡∏∞ leaveDays
            const monthLeaves = leaveDays.filter(l => l.date >= firstDayOfMonth && l.date <= lastDayOfMonth);
            const monthDayOffsTotal = dayOffs.filter(d => d >= firstDayOfMonth && d <= lastDayOfMonth).length;
            
            const holidayCount = monthLeaves.filter(l => l.type === 'holiday').length;
            const vacationCount = monthLeaves.filter(l => l.type === 'vacation').length;
            const sickCount = monthLeaves.filter(l => l.type === 'sick').length;
            const personalCount = monthLeaves.filter(l => l.type === 'personal').length;
            
            // ‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = dayOffs + leaveDays
            const totalLeaveDays = monthDayOffsTotal + monthLeaves.length;

            const holidayEl = document.getElementById('leaveHolidayCount');
            const vacationEl = document.getElementById('leaveVacationCount');
            const sickEl = document.getElementById('leaveSickCount');
            const personalEl = document.getElementById('leavePersonalCount');
            
            if (holidayEl) holidayEl.textContent = holidayCount;
            if (vacationEl) vacationEl.textContent = vacationCount;
            if (sickEl) sickEl.textContent = sickCount;
            if (personalEl) personalEl.textContent = personalCount;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Add day headers
            const dayNames = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Add days from previous month
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayDiv = createCalendarDay(day, month - 1, year, true);
                grid.appendChild(dayDiv);
            }

            // Add days of current month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate() && 
                               month === today.getMonth() && 
                               year === today.getFullYear();
                const dayDiv = createCalendarDay(day, month, year, false, isToday);
                grid.appendChild(dayDiv);
            }

            // Add days from next month to fill the grid
            const totalCells = grid.children.length - 7; // minus headers
            const remainingCells = 42 - totalCells - 7; // 6 rows * 7 days - headers
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = createCalendarDay(day, month + 1, year, true);
                grid.appendChild(dayDiv);
            }
        }

        function createCalendarDay(day, month, year, otherMonth = false, isToday = false) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            
            if (otherMonth) {
                dayDiv.classList.add('other-month');
            }
            if (isToday) {
                dayDiv.classList.add('today');
            }

            // Get todos for this day
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayTodos = todos.filter(t => t.dueDate === dateStr);
            const isDayOff = dayOffs.includes(dateStr);
            const dayLeave = leaveDays.find(l => l.date === dateStr);
            
            // Check for overdue todos
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            const thisDate = new Date(year, month, day);
            thisDate.setHours(0, 0, 0, 0);
            const hasOverdue = dayTodos.some(t => !t.completed && thisDate < currentDate);
            
            // Get branch info for the day
            const branchesForDay = new Set();
            dayTodos.forEach(t => {
                if (t.branches && t.branches.length > 0) {
                    t.branches.forEach(b => branchesForDay.add(b));
                }
            });
            const branchText = branchesForDay.size > 0 ? 
                Array.from(branchesForDay).join(',') : '';

            if (dayTodos.length > 0) {
                dayDiv.classList.add('has-todos');
            }
            
            if (isDayOff || dayLeave) {
                dayDiv.classList.add('day-off');
            }

            if (hasOverdue) {
                dayDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            }

            // Get leave badge HTML
            let leaveBadgeHTML = '';
            if (isDayOff) {
                leaveBadgeHTML = '<div class="day-off-badge" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">üèñÔ∏è Day Off</div>';
            } else if (dayLeave) {
                const leaveInfo = leaveTypes[dayLeave.type];
                const bgColor = {
                    holiday: 'linear-gradient(135deg, #f59e0b, #d97706)',
                    vacation: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                    sick: 'linear-gradient(135deg, #ef4444, #dc2626)',
                    personal: 'linear-gradient(135deg, #8b5cf6, #7c3aed)'
                };
                leaveBadgeHTML = `<div class="day-off-badge" style="background: ${bgColor[dayLeave.type]};">${leaveInfo.icon} ${leaveInfo.name}</div>`;
            }

            dayDiv.innerHTML = `
                <div class="day-number">${day}</div>
                ${leaveBadgeHTML}
                <div class="calendar-day-content">
                    ${(() => {
                        // Show branch visits first (at top)
                        const dayVisits = branchVisits.filter(v => v.date === dateStr);
                        const visitHTML = dayVisits.map(visit => {
                            const displayName = branchNames[visit.branch] || visit.branch;
                            return `
                            <div class="calendar-branch-visit" onclick="event.stopPropagation(); editBranchVisit(${visit.id})">
                                <span>üè¢ ${displayName}</span>
                                <span class="branch-visit-time">‚è∞ ${visit.time.substring(0, 5)}</span>
                            </div>
                        `}).join('');
                        
                        // Then show regular tasks
                        const taskHTML = dayTodos.slice(0, 3).map(todo => {
                            const time = todo.timeStart ? todo.timeStart.substring(0, 5) : '';
                            const branch = todo.branches && todo.branches.length > 0 ? todo.branches[0] : '';
                            const taskText = todo.text.length > 15 ? todo.text.substring(0, 15) + '...' : todo.text;
                            const icon = todo.icon ? todo.icon + ' ' : '';
                            return `
                                <div class="calendar-task-item priority-${todo.priority} ${todo.completed ? 'completed' : ''}" 
                                     onclick="event.stopPropagation(); editTodo(${todo.id})">
                                    ${branch ? `<span class="calendar-task-branch">${branch}</span>` : ''}
                                    ${time ? `<span class="calendar-task-time">${time}</span>` : ''}
                                    <span>${icon}${taskText}</span>
                                </div>
                            `;
                        }).join('');
                        
                        const moreHTML = dayTodos.length > 3 ? `<div class="calendar-more-tasks">+${dayTodos.length - 3} ‡∏á‡∏≤‡∏ô</div>` : '';
                        
                        return visitHTML + taskHTML + moreHTML;
                    })()}
                </div>
            `;

            // Click to show todos (for +more tasks or empty space)
            dayDiv.onclick = () => showDayTodos(dateStr, day, month, year);

            return dayDiv;
        }

        function showDayTodos(dateStr, day, month, year) {
            currentSelectedDate = dateStr;
            const dayTodos = todos.filter(t => t.dueDate === dateStr);
            const dayVisits = branchVisits.filter(v => v.date === dateStr);
            const isDayOff = dayOffs.includes(dateStr);
            const dayLeave = leaveDays.find(l => l.date === dateStr);
            
            const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                              '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            
            document.getElementById('modalDate').textContent = `‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day} ${monthNames[month]} ${year + 543}`;
            
            // Set leave type radio buttons
            const radios = document.getElementsByName('leaveType');
            radios.forEach(radio => {
                if (isDayOff && radio.value === 'dayoff') {
                    radio.checked = true;
                } else if (dayLeave && radio.value === dayLeave.type) {
                    radio.checked = true;
                } else if (!isDayOff && !dayLeave && radio.value === '') {
                    radio.checked = true;
                }
            });
            
            const modalTodos = document.getElementById('modalTodos');
            modalTodos.innerHTML = '';

            // Show branch visits first with edit/delete buttons
            if (dayVisits.length > 0) {
                const visitsSection = document.createElement('div');
                visitsSection.style.marginBottom = '15px';
                visitsSection.innerHTML = '<div style="font-weight: 600; margin-bottom: 10px; color: var(--success);">üè¢ ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤</div>';
                
                dayVisits.forEach(visit => {
                    const displayName = branchNames[visit.branch] || visit.branch;
                    const visitItem = document.createElement('div');
                    visitItem.className = 'todo-item';
                    visitItem.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1))';
                    visitItem.style.borderLeft = '4px solid var(--success)';
                    visitItem.innerHTML = `
                        <div class="checkbox-wrapper">
                            <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                                üè¢
                            </div>
                        </div>
                        <div class="todo-content">
                            <div class="todo-text">${displayName}</div>
                            <div class="todo-meta">
                                <span class="due-date">‚è∞ ${visit.time.substring(0, 5)}</span>
                            </div>
                        </div>
                        <div class="todo-actions">
                            <button class="icon-btn" onclick="editBranchVisit(${visit.id})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                            <button class="icon-btn delete" onclick="deleteBranchVisitFromModal(${visit.id})" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </div>
                    `;
                    visitsSection.appendChild(visitItem);
                });
                
                modalTodos.appendChild(visitsSection);
            }

            // Show regular todos
            if (dayTodos.length === 0 && dayVisits.length === 0) {
                let statusText = '';
                if (isDayOff) statusText = 'üèñÔ∏è Day Off';
                else if (dayLeave) {
                    const leaveInfo = leaveTypes[dayLeave.type];
                    statusText = `${leaveInfo.icon} ${leaveInfo.name}`;
                }
                
                modalTodos.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-text">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                        ${statusText ? `<p style="color: var(--secondary); font-weight: 600;">${statusText}</p>` : ''}
                    </div>
                `;
            } else if (dayTodos.length > 0) {
                if (dayVisits.length > 0) {
                    const todosSection = document.createElement('div');
                    todosSection.innerHTML = '<div style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">üìã ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</div>';
                    modalTodos.appendChild(todosSection);
                }
                
                dayTodos.forEach(todo => {
                    modalTodos.appendChild(createTodoItem(todo));
                });
            }

            document.getElementById('calendarModal').classList.add('active');
        }

        function deleteBranchVisitFromModal(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ?')) return;

            branchVisits = branchVisits.filter(v => v.id !== id);
            saveBranchVisits();
            renderCalendar();
            renderWeekPlan();

            // Refresh modal
            if (currentSelectedDate) {
                const date = new Date(currentSelectedDate);
                showDayTodos(currentSelectedDate, date.getDate(), date.getMonth(), date.getFullYear());
            }

            showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function handleLeaveTypeChange() {
            if (!currentSelectedDate) return;
            
            const selectedType = document.querySelector('input[name="leaveType"]:checked').value;
            
            // Remove from dayOffs if exists
            const dayOffIndex = dayOffs.indexOf(currentSelectedDate);
            if (dayOffIndex !== -1) {
                dayOffs.splice(dayOffIndex, 1);
            }
            
            // Remove from leaveDays if exists
            const leaveIndex = leaveDays.findIndex(l => l.date === currentSelectedDate);
            if (leaveIndex !== -1) {
                leaveDays.splice(leaveIndex, 1);
            }
            
            // Add based on selection
            if (selectedType === 'dayoff') {
                dayOffs.push(currentSelectedDate);
                showToast('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Day Off ‡πÅ‡∏•‡πâ‡∏ß!');
            } else if (selectedType !== '') {
                leaveDays.push({
                    date: currentSelectedDate,
                    type: selectedType,
                    createdAt: new Date().toISOString()
                });
                const leaveInfo = leaveTypes[selectedType];
                showToast(`‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô${leaveInfo.name}‡πÅ‡∏•‡πâ‡∏ß!`);
            } else {
                showToast('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
            }
            
            localStorage.setItem('dayOffs', JSON.stringify(dayOffs));
            localStorage.setItem('leaveDays', JSON.stringify(leaveDays));
            renderCalendar();
            renderWeekPlan();
            renderDashboardSummary();
        }

        function toggleDayOff() {
            if (!currentSelectedDate) return;
            
            const checkbox = document.getElementById('dayOffCheckbox');
            const index = dayOffs.indexOf(currentSelectedDate);
            
            if (checkbox.checked && index === -1) {
                dayOffs.push(currentSelectedDate);
                showToast('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß!');
            } else if (!checkbox.checked && index !== -1) {
                dayOffs.splice(index, 1);
                showToast('‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
            }
            
            localStorage.setItem('dayOffs', JSON.stringify(dayOffs));
            localStorage.setItem('leaveDays', JSON.stringify(leaveDays));
            renderCalendar();
            renderWeekPlan();
            renderDashboardSummary();
        }

        function closeModal(event) {
            if (!event || event.target.id === 'calendarModal') {
                document.getElementById('calendarModal').classList.remove('active');
            }
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        function todayMonth() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        // Notifications
        function updateNotifications() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let notifications = [];

            // Overdue tasks
            const overdue = todos.filter(t => {
                if (!t.dueDate || t.completed) return false;
                const dueDate = new Date(t.dueDate);
                return dueDate < today;
            });

            overdue.forEach(todo => {
                notifications.push({
                    type: 'urgent',
                    text: `‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${todo.text}`,
                    time: `‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${formatDate(todo.dueDate)}${todo.dueTime ? ' ' + todo.dueTime : ''}`,
                    todo: todo
                });
            });

            // Today's tasks
            const todayTasks = todos.filter(t => {
                if (!t.dueDate || t.completed) return false;
                return t.dueDate === today.toISOString().split('T')[0];
            });

            todayTasks.forEach(todo => {
                notifications.push({
                    type: 'today',
                    text: `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${todo.text}`,
                    time: todo.dueTime ? `‚è∞ ${todo.dueTime}` : '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô',
                    todo: todo
                });
            });

            // Tomorrow's tasks
            const tomorrowTasks = todos.filter(t => {
                if (!t.dueDate || t.completed) return false;
                return t.dueDate === tomorrow.toISOString().split('T')[0];
            });

            tomorrowTasks.forEach(todo => {
                notifications.push({
                    type: 'tomorrow',
                    text: `‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ: ${todo.text}`,
                    time: todo.dueTime ? `‚è∞ ${todo.dueTime}` : '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô',
                    todo: todo
                });
            });

            // Update badge
            const badge = document.getElementById('notificationBadge');
            const count = document.getElementById('notificationCount');
            if (notifications.length > 0) {
                badge.style.display = 'flex';
                badge.textContent = notifications.length;
                count.textContent = `(${notifications.length})`;
            } else {
                badge.style.display = 'none';
                count.textContent = '';
            }

            // Render notifications
            const list = document.getElementById('notificationList');
            list.innerHTML = '';

            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="empty-state" style="padding: 30px;">
                        <div class="empty-state-icon" style="font-size: 3rem;">‚úÖ</div>
                        <div class="empty-state-text">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å!</p>
                    </div>
                `;
            } else {
                notifications.forEach(notif => {
                    const item = document.createElement('div');
                    item.className = `notification-item ${notif.type}`;
                    item.innerHTML = `
                        <div class="notification-text">${notif.text}</div>
                        <div class="notification-time">${notif.time}</div>
                    `;
                    item.onclick = () => {
                        toggleNotifications();
                        // Scroll to todo in list view
                        if (currentView === 'calendar') {
                            switchView('list');
                        }
                    };
                    list.appendChild(item);
                });
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('show');
        }

        // Week Plan
        function renderWeekPlan() {
            const container = document.getElementById('weekDays');
            container.innerHTML = '';

            // Start from today, show 5 days ahead
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const dayNames = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];

            // Show 5 days starting from today
            for (let i = 0; i < 5; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                // Use EXACT same format as calendar
                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const isToday = i === 0;
                const dayTodos = todos.filter(t => t.dueDate === dateStr);
                const dayVisits = branchVisits.filter(v => v.date === dateStr);
                const dayLeaves = leaveDays.filter(l => l.date === dateStr);
                const isDayOff = dayOffs.includes(dateStr);
                
                const card = document.createElement('div');
                card.className = `week-day-card ${isToday ? 'today' : ''}`;
                
                const dayName = dayNames[date.getDay()];
                
                card.innerHTML = `
                    <div class="week-day-header">
                        <div class="week-day-name">${dayName}${isToday ? ' (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)' : ''}</div>
                        <div class="week-day-date">${day}/${month + 1}</div>
                    </div>
                    <div class="week-day-todos" id="week-${dateStr}"></div>
                `;

                const todosContainer = card.querySelector('.week-day-todos');
                
                // Show branch visits first (at top)
                if (dayVisits.length > 0) {
                    dayVisits.forEach(visit => {
                        const displayName = branchNames[visit.branch] || visit.branch;
                        const visitItem = document.createElement('div');
                        visitItem.className = 'week-branch-visit';
                        visitItem.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                <span>üè¢ ${displayName}</span>
                                <span style="font-size: 0.7rem; opacity: 0.9;">‚è∞ ${visit.time.substring(0, 5)}</span>
                            </div>
                            <div style="display: flex; gap: 4px;">
                                <button class="icon-btn-small" onclick="event.stopPropagation(); editBranchVisit(${visit.id})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 4px 6px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úèÔ∏è</button>
                                <button class="icon-btn-small" onclick="event.stopPropagation(); deleteBranchVisitFromWeek(${visit.id})" title="‡∏•‡∏ö" style="background: rgba(239,68,68,0.8); color: white; border: none; padding: 4px 6px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>
                            </div>
                        `;
                        todosContainer.appendChild(visitItem);
                    });
                }
                
                // Show day off
                if (isDayOff) {
                    const dayOffItem = document.createElement('div');
                    dayOffItem.className = 'week-leave-item';
                    dayOffItem.style.background = 'linear-gradient(135deg, #06b6d4, #0891b2)';
                    dayOffItem.innerHTML = 'üèñÔ∏è Day Off';
                    todosContainer.appendChild(dayOffItem);
                }
                
                // Show leave days
                if (dayLeaves.length > 0) {
                    dayLeaves.forEach(leave => {
                        const leaveInfo = leaveTypes[leave.type];
                        const leaveItem = document.createElement('div');
                        leaveItem.className = `week-leave-item leave-${leave.type}`;
                        leaveItem.innerHTML = `${leaveInfo.icon} ${leaveInfo.name}`;
                        todosContainer.appendChild(leaveItem);
                    });
                }
                
                // Then show regular todos
                if (dayTodos.length === 0 && dayVisits.length === 0 && dayLeaves.length === 0 && !isDayOff) {
                    todosContainer.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.8rem; text-align: center; padding: 10px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>';
                } else if (dayTodos.length > 0) {
                    dayTodos.forEach(todo => {
                        const todoItem = document.createElement('div');
                        todoItem.className = 'week-todo-item';
                        
                        const timeDisplay = todo.timeStart && todo.timeEnd ? 
                            `‚è∞ ${todo.timeStart}-${todo.timeEnd}` : 
                            (todo.timeStart ? `‚è∞ ${todo.timeStart}` : '');
                        
                        const branchDisplay = todo.branches && todo.branches.length > 0 ? 
                            `üè¢ ${todo.branches.join(', ')}` : '';
                        
                        const iconDisplay = todo.icon ? `${todo.icon} ` : '';
                        
                        todoItem.innerHTML = `
                            <div class="week-todo-checkbox ${todo.completed ? 'checked' : ''}" onclick="toggleTodo(${todo.id})"></div>
                            <div class="week-todo-content">
                                <div class="week-todo-text ${todo.completed ? 'completed' : ''}">${iconDisplay}${todo.text}</div>
                                <div class="week-todo-meta">
                                    ${branchDisplay}
                                    ${timeDisplay}
                                    <span class="priority-badge priority-${todo.priority}" style="padding: 2px 6px; font-size: 0.7rem;">${getPriorityText(todo.priority)}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 4px; margin-left: 8px;">
                                <button class="icon-btn-small" onclick="event.stopPropagation(); editTodo(${todo.id})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" style="background: var(--bg-hover); border: 1px solid var(--border); padding: 4px 6px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úèÔ∏è</button>
                                <button class="icon-btn-small" onclick="event.stopPropagation(); deleteTodoFromWeek(${todo.id})" title="‡∏•‡∏ö" style="background: var(--danger); color: white; border: none; padding: 4px 6px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>
                            </div>
                        `;
                        
                        todosContainer.appendChild(todoItem);
                    });
                }

                container.appendChild(card);
            }
        }

        function refreshWeekPlan() {
            renderWeekPlan();
            updateNotifications();
        }

        function deleteBranchVisitFromWeek(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ?')) return;

            branchVisits = branchVisits.filter(v => v.id !== id);
            saveBranchVisits();
            renderCalendar();
            renderWeekPlan();

            showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function deleteTodoFromWeek(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) return;

            todos = todos.filter(t => t.id !== id);
            saveTodos();
            refreshAllViews();

            showToast('üóëÔ∏è ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        // Debug Functions
        function showDebugInfo() {
            const panel = document.getElementById('debugPanel');
            const backdrop = document.getElementById('debugBackdrop');
            const content = document.getElementById('debugContent');
            
            let html = '<div style="font-family: monospace;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: var(--primary); color: white;"><th style="padding: 10px; border: 1px solid var(--border);">ID</th><th style="padding: 10px; border: 1px solid var(--border);">‡∏á‡∏≤‡∏ô</th><th style="padding: 10px; border: 1px solid var(--border);">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th><th style="padding: 10px; border: 1px solid var(--border);">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr></thead>';
            html += '<tbody>';
            
            todos.forEach(todo => {
                html += `<tr style="border: 1px solid var(--border);">`;
                html += `<td style="padding: 10px; border: 1px solid var(--border);">${todo.id}</td>`;
                html += `<td style="padding: 10px; border: 1px solid var(--border);">${todo.text}</td>`;
                html += `<td style="padding: 10px; border: 1px solid var(--border);">`;
                html += `<input type="date" value="${todo.dueDate || ''}" id="date-${todo.id}" style="padding: 5px; border: 2px solid var(--border); border-radius: 5px; background: var(--bg-main); color: var(--text-primary);">`;
                html += `</td>`;
                html += `<td style="padding: 10px; border: 1px solid var(--border);">`;
                html += `<button class="btn btn-primary" onclick="fixTodoDate(${todo.id})" style="padding: 5px 10px;">üíæ ‡πÅ‡∏Å‡πâ</button>`;
                html += `</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            html += '<div style="margin-top: 20px; text-align: center;">';
            html += '<button class="btn btn-primary" onclick="closeDebugPanel()" style="padding: 10px 30px;">‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>';
            html += '</div>';
            html += '</div>';
            
            content.innerHTML = html;
            panel.style.display = 'block';
            backdrop.style.display = 'block';
        }

        function closeDebugPanel() {
            document.getElementById('debugPanel').style.display = 'none';
            document.getElementById('debugBackdrop').style.display = 'none';
        }

        function fixTodoDate(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;
            
            const newDate = document.getElementById(`date-${id}`).value;
            if (!newDate) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
                return;
            }
            
            todo.dueDate = newDate;
            saveTodos();
            renderTodos();
            renderCalendar();
            renderWeekPlan();
            
            showToast(`‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô "${todo.text}" ‡πÄ‡∏õ‡πá‡∏ô ${newDate} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            
            // Refresh debug panel
            showDebugInfo();
        }

        // Bulk Add Tasks Functions
        function toggleBulkAdd() {
            const container = document.getElementById('bulkAddContainer');
            
            if (container.classList.contains('show')) {
                container.classList.remove('show');
            } else {
                container.classList.add('show');
                // Set default date to today
                document.getElementById('bulkDefaultDate').value = new Date().toISOString().split('T')[0];
            }
        }

        function parseBulkTask(line) {
            // Remove extra spaces
            line = line.trim();
            if (!line) return null;

            // Parse format: task | priority | category | date | timeStart | timeEnd | icon
            const parts = line.split('|').map(p => p.trim());
            
            // Use selected emoji if no emoji in line
            const taskIcon = parts[6] || selectedBulkEmoji || '';
            
            const task = {
                text: parts[0],
                priority: parts[1] || document.getElementById('bulkDefaultPriority').value,
                category: parts[2] || document.getElementById('bulkDefaultCategory').value,
                dueDate: parts[3] || document.getElementById('bulkDefaultDate').value,
                timeStart: parts[4] || '',
                timeEnd: parts[5] || '',
                icon: taskIcon
            };

            // Validate priority
            if (!['low', 'medium', 'high'].includes(task.priority)) {
                task.priority = document.getElementById('bulkDefaultPriority').value;
            }

            // Validate category
            if (!['work', 'personal', 'shopping', 'health', 'study'].includes(task.category)) {
                task.category = document.getElementById('bulkDefaultCategory').value;
            }

            return task;
        }

        function updateBulkPreview() {
            const input = document.getElementById('bulkTaskInput').value;
            const lines = input.split('\n').filter(line => line.trim());
            
            const preview = document.getElementById('bulkPreview');
            const previewList = document.getElementById('bulkPreviewList');
            const count = document.getElementById('bulkCount');
            const addCount = document.getElementById('bulkAddCount');
            
            if (lines.length === 0) {
                preview.style.display = 'none';
                return;
            }

            preview.style.display = 'block';
            previewList.innerHTML = '';
            
            const tasks = lines.map(line => parseBulkTask(line)).filter(t => t !== null);
            count.textContent = tasks.length;
            addCount.textContent = tasks.length;

            const categoryIcons = {
                work: 'üíº',
                personal: 'üë§',
                shopping: 'üõí',
                health: 'üí™',
                study: 'üìö'
            };

            const priorityColors = {
                high: 'üî¥',
                medium: 'üü°',
                low: 'üü¢'
            };

            tasks.slice(0, 10).forEach(task => {
                const item = document.createElement('div');
                item.className = 'bulk-preview-item';
                const timeDisplay = task.timeStart && task.timeEnd ? 
                    `‚è∞ ${task.timeStart}-${task.timeEnd}` : 
                    (task.timeStart ? `‚è∞ ${task.timeStart}` : '');
                item.innerHTML = `
                    <span class="icon">${categoryIcons[task.category]}</span>
                    <span class="icon">${priorityColors[task.priority]}</span>
                    <span style="flex: 1;">${task.text}</span>
                    ${task.dueDate ? `<span style="font-size: 0.8rem; color: var(--text-secondary);">üìÖ ${formatDate(task.dueDate)}${timeDisplay ? ' ' + timeDisplay : ''}</span>` : ''}
                `;
                previewList.appendChild(item);
            });

            if (tasks.length > 10) {
                const more = document.createElement('div');
                more.className = 'bulk-preview-item';
                more.innerHTML = `<span style="color: var(--text-secondary);">... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${tasks.length - 10} ‡∏á‡∏≤‡∏ô</span>`;
                previewList.appendChild(more);
            }
        }

        function addBulkTasks() {
            const input = document.getElementById('bulkTaskInput').value;
            const lines = input.split('\n').filter(line => line.trim());
            
            if (lines.length === 0) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°', 'error');
                return;
            }

            const tasks = lines.map(line => parseBulkTask(line)).filter(t => t !== null);
            
            if (tasks.length === 0) {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }

            let added = 0;
            tasks.forEach((taskData, index) => {
                const todo = {
                    id: Date.now() + index,
                    text: taskData.text,
                    completed: false,
                    priority: taskData.priority,
                    category: taskData.category,
                    dueDate: taskData.dueDate,
                    timeStart: taskData.timeStart,
                    timeEnd: taskData.timeEnd,
                    createdAt: new Date().toISOString()
                };

                todos.unshift(todo);
                added++;
            });

            saveTodos();
            updateSidebarCounts();
            renderTodos();
            updateStats();
            updateNotifications();
            renderWeekPlan();
            if (currentView === 'calendar') {
                renderCalendar();
            }

            // Clear form
            document.getElementById('bulkTaskInput').value = '';
            document.getElementById('bulkAddContainer').classList.remove('show');
            updateBulkPreview();

            showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${added} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£!`);
        }

        function clearBulkInput() {
            document.getElementById('bulkTaskInput').value = '';
            updateBulkPreview();
        }

        // Recurring Task Functions
        function toggleRecurringOptions() {
            const checkbox = document.getElementById('recurringCheckbox');
            const options = document.getElementById('recurringOptions');
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                options.classList.add('show');
                setDefaultRecurringDates();
                updateRecurringConfig();
            } else {
                options.classList.remove('show');
            }
        }

        function setDefaultRecurringDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recurringStartDate').value = today;
        }

        function updateRecurringConfig() {
            const type = document.getElementById('recurringType').value;
            const weekdayField = document.getElementById('weekdayField');
            const intervalField = document.getElementById('intervalField');
            
            // Reset weekday selection
            selectedWeekdays = [];
            document.querySelectorAll('.weekday-btn').forEach(btn => btn.classList.remove('selected'));
            
            if (type === 'custom') {
                weekdayField.style.display = 'block';
                intervalField.style.display = 'block';
            } else if (type === 'weekly') {
                weekdayField.style.display = 'block';
                intervalField.style.display = 'block';
            } else if (type === 'weekdays') {
                weekdayField.style.display = 'none';
                intervalField.style.display = 'none';
                selectedWeekdays = [1, 2, 3, 4, 5]; // Mon-Fri
            } else if (type === 'weekends') {
                weekdayField.style.display = 'none';
                intervalField.style.display = 'none';
                selectedWeekdays = [0, 6]; // Sun, Sat
            } else {
                weekdayField.style.display = 'none';
                intervalField.style.display = 'block';
            }
            
            updateRecurringPreview();
        }

        function toggleWeekday(day) {
            const index = selectedWeekdays.indexOf(day);
            const btn = document.querySelector(`.weekday-btn[data-day="${day}"]`);
            
            if (index > -1) {
                selectedWeekdays.splice(index, 1);
                btn.classList.remove('selected');
            } else {
                selectedWeekdays.push(day);
                btn.classList.add('selected');
            }
            
            updateRecurringPreview();
        }

        function updateRecurringPreview() {
            const type = document.getElementById('recurringType').value;
            const interval = parseInt(document.getElementById('recurringInterval').value) || 1;
            const previewText = document.getElementById('recurringPreviewText');
            
            let text = '';
            const dayNames = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
            
            switch(type) {
                case 'daily':
                    text = interval === 1 ? '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô' : `‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å ${interval} ‡∏ß‡∏±‡∏ô`;
                    break;
                case 'weekly':
                    if (selectedWeekdays.length > 0) {
                        const days = selectedWeekdays.sort().map(d => dayNames[d]).join(', ');
                        text = interval === 1 ? 
                            `‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô: ${days}` :
                            `‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å ${interval} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô: ${days}`;
                    } else {
                        text = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£';
                    }
                    break;
                case 'monthly':
                    text = interval === 1 ? '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : `‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å ${interval} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
                    break;
                case 'weekdays':
                    text = '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå';
                    break;
                case 'weekends':
                    text = '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå';
                    break;
                case 'custom':
                    if (selectedWeekdays.length > 0) {
                        const days = selectedWeekdays.sort().map(d => dayNames[d]).join(', ');
                        text = `‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô: ${days}`;
                    } else {
                        text = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£';
                    }
                    break;
            }
            
            previewText.textContent = text;
        }

        function getRecurringText(recurring) {
            if (!recurring) return '';
            
            const type = recurring.type;
            const interval = recurring.interval;
            
            switch(type) {
                case 'daily':
                    return interval === 1 ? '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô' : `‡∏ó‡∏∏‡∏Å ${interval} ‡∏ß‡∏±‡∏ô`;
                case 'weekly':
                    return interval === 1 ? '‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå' : `‡∏ó‡∏∏‡∏Å ${interval} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå`;
                case 'monthly':
                    return interval === 1 ? '‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : `‡∏ó‡∏∏‡∏Å ${interval} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
                case 'weekdays':
                    return '‡∏à-‡∏®';
                case 'weekends':
                    return '‡∏™-‡∏≠‡∏≤';
                case 'custom':
                    return '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á';
                default:
                    return '‡∏ó‡∏≥‡∏ã‡πâ‡∏≥';
            }
        }

        function generateRecurringTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // Find all recurring parent tasks
            const recurringParents = todos.filter(t => t.recurring && !t.parentId);
            
            recurringParents.forEach(parent => {
                const config = parent.recurring;
                
                // Check if we need to generate for today
                if (config.lastGenerated === todayStr) return;
                
                // Check if today is within the recurring range
                const startDate = new Date(config.startDate);
                startDate.setHours(0, 0, 0, 0);
                
                if (today < startDate) return;
                
                if (config.endDate) {
                    const endDate = new Date(config.endDate);
                    endDate.setHours(0, 0, 0, 0);
                    if (today > endDate) return;
                }
                
                // Check if today matches the recurring pattern
                if (shouldGenerateForDate(today, config)) {
                    // Check if instance already exists for today
                    const existingInstance = todos.find(t => 
                        t.parentId === parent.id && t.dueDate === todayStr
                    );
                    
                    if (!existingInstance) {
                        // Create new instance
                        const instance = {
                            ...parent,
                            id: Date.now() + Math.random(),
                            dueDate: todayStr,
                            parentId: parent.id,
                            completed: false,
                            createdAt: new Date().toISOString()
                        };
                        
                        delete instance.recurring; // Instances don't have recurring config
                        todos.push(instance);
                    }
                }
                
                // Update last generated date
                parent.recurring.lastGenerated = todayStr;
            });
            
            saveTodos();
        }

        function shouldGenerateForDate(date, config) {
            const dayOfWeek = date.getDay();
            
            switch(config.type) {
                case 'daily':
                    const startDate = new Date(config.startDate);
                    startDate.setHours(0, 0, 0, 0);
                    const daysDiff = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
                    return daysDiff % config.interval === 0;
                    
                case 'weekly':
                    if (!config.weekdays || config.weekdays.length === 0) return false;
                    return config.weekdays.includes(dayOfWeek);
                    
                case 'monthly':
                    const startDay = new Date(config.startDate).getDate();
                    return date.getDate() === startDay;
                    
                case 'weekdays':
                    return dayOfWeek >= 1 && dayOfWeek <= 5;
                    
                case 'weekends':
                    return dayOfWeek === 0 || dayOfWeek === 6;
                    
                case 'custom':
                    if (!config.weekdays || config.weekdays.length === 0) return false;
                    return config.weekdays.includes(dayOfWeek);
                    
                default:
                    return false;
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>